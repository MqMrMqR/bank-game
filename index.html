<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANK GAME</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.21.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.21.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.21.0/firebase-auth-compat.min.js"></script>
     <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

<!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary-color: #000;
            --secondary-color: #fff;
            --accent-color: #333;
            --text-color: #000;
            --background-color: #fff;
            --border-color: #ddd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        .rtl {
            direction: rtl;
            text-align: right;
        }

        .ltr {
            direction: ltr;
            text-align: left;
        }

        header {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            color: var(--secondary-color);
        }

        .language-toggle {
            background: transparent;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .login-container, .register-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .balance {
            font-size: 2rem;
            font-weight: bold;
        }

        .currency {
            font-size: 0.8rem;
            color: #777;
        }

        .card {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .card-number {
            font-size: 1.2rem;
            letter-spacing: 4px;
            margin: 1rem 0;
        }

        .card-holder {
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .card-expiry {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            font-size: 0.8rem;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .action-item {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .transactions {
            margin-top: 2rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        form {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--accent-color);
        }

        .wallet-container {
            margin-top: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .wallet-address {
            font-family: monospace;
            padding: 0.5rem;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin: 0.5rem 0;
            word-break: break-all;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--background-color);
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .tab-container {
            margin-top: 2rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            padding: 1.5rem 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="rtl">
    <header>
        <a href="#" class="logo">BANK GAME</a>
        <button class="language-toggle" onclick="toggleLanguage()">English</button>
    </header>

    <div class="container">
        <!-- Login Form -->
        <div class="login-container" id="loginForm">
            <h2 data-ar="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" data-en="Login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <form id="login">
                <div class="form-group">
                    <label for="loginEmail" data-ar="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-en="Email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword" data-ar="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-en="Password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" data-ar="Ø¯Ø®ÙˆÙ„" data-en="Login">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                <a href="#" id="showRegister" data-ar="Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†" data-en="Don't have an account? Register now">Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</a>
            </p>
        </div>

        <!-- Register Form -->
        <div class="register-container" id="registerForm" style="display: none;">
            <h2 data-ar="Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" data-en="Create New Account">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <form id="register">
                <div class="form-group">
                    <label for="registerName" data-ar="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" data-en="Full Name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail" data-ar="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-en="Email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword" data-ar="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-en="Password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword" data-ar="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-en="Confirm Password">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <button type="submit" data-ar="ØªØ³Ø¬ÙŠÙ„" data-en="Register">ØªØ³Ø¬ÙŠÙ„</button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                <a href="#" id="showLogin" data-ar="Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" data-en="Already have an account? Login">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
            </p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <div>
                    <h2 data-ar="Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ " data-en="Welcome, "><span id="userNameDisplay">Ù…Ø³ØªØ®Ø¯Ù…</span></h2>
                </div>
                <button id="logoutBtn" data-ar="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" data-en="Logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>

            <div class="card">
                <h3 data-ar="Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†" data-en="Credit Card">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†</h3>
                <div class="card-number">**** **** **** <span id="lastFourDigits">1234</span></div>
                <div class="card-holder" id="cardHolderName">Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</div>
                <div class="card-expiry">12/28</div>
            </div>

            <div class="balance-section">
                <h3 data-ar="Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ" data-en="Current Balance">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                <div class="balance"><span id="balanceAmount">0</span> <span class="currency" data-ar="Ø±ÙŠØ§Ù„" data-en="SAR">Ø±ÙŠØ§Ù„</span></div>
            </div>

            <div class="actions">
                <div class="action-item" id="depositBtn">
                    <div class="action-icon">ğŸ’°</div>
                    <h3 data-ar="Ø¥ÙŠØ¯Ø§Ø¹" data-en="Deposit">Ø¥ÙŠØ¯Ø§Ø¹</h3>
                </div>
                <div class="action-item" id="transferBtn">
                    <div class="action-icon">â†—ï¸</div>
                    <h3 data-ar="ØªØ­ÙˆÙŠÙ„" data-en="Transfer">ØªØ­ÙˆÙŠÙ„</h3>
                </div>
                <div class="action-item" id="walletsBtn">
                    <div class="action-icon">ğŸ’¼</div>
                    <h3 data-ar="Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©" data-en="Digital Wallets">Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h3>
                </div>
                <div class="action-item" id="historyBtn">
                    <div class="action-icon">ğŸ“œ</div>
                    <h3 data-ar="Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" data-en="Transaction History">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                </div>
            </div>

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="recent-transactions" data-ar="Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" data-en="Recent Transactions">Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                    <div class="tab" data-tab="wallets" data-ar="Ø§Ù„Ù…Ø­Ø§ÙØ¸" data-en="Wallets">Ø§Ù„Ù…Ø­Ø§ÙØ¸</div>
                </div>

                <div class="tab-content">
                    <div class="tab-pane active" id="recent-transactions">
                        <div class="transactions" id="transactionsList">
                            <div class="transaction-item">
                                <div>
                                    <strong data-ar="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª" data-en="No transactions yet">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="wallets">
                        <div class="wallet-container">
                            <div class="wallet-header">
                                <h3>Bitcoin (BTC)</h3>
                                <div><span id="btcBalance">0</span> BTC</div>
                            </div>
                            <div>
                                <p data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:" data-en="Wallet Address:">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:</p>
                                <div class="wallet-address" id="btcAddress">bc1q87de3fagf7agfg78afg78ga78fg7a8g7</div>
                            </div>
                        </div>
                        
                        <div class="wallet-container">
                            <div class="wallet-header">
                                <h3>Ethereum (ETH)</h3>
                                <div><span id="ethBalance">0</span> ETH</div>
                            </div>
                            <div>
                                <p data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:" data-en="Wallet Address:">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:</p>
                                <div class="wallet-address" id="ethAddress">0x87de3f7agf7agfg78afg78ga78fg7a8g7</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <span class="close-modal" id="closeDepositModal">&times;</span>
            <h2 data-ar="Ø¥ÙŠØ¯Ø§Ø¹ Ø£Ù…ÙˆØ§Ù„" data-en="Deposit Money">Ø¥ÙŠØ¯Ø§Ø¹ Ø£Ù…ÙˆØ§Ù„</h2>
            <form id="depositForm">
                <div class="form-group">
                    <label for="depositAmount" data-ar="Ø§Ù„Ù…Ø¨Ù„Øº" data-en="Amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input type="number" id="depositAmount" min="1" required>
                </div>
                <button type="submit" data-ar="Ø¥ÙŠØ¯Ø§Ø¹" data-en="Deposit">Ø¥ÙŠØ¯Ø§Ø¹</button>
            </form>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <span class="close-modal" id="closeTransferModal">&times;</span>
            <h2 data-ar="ØªØ­ÙˆÙŠÙ„ Ø£Ù…ÙˆØ§Ù„" data-en="Transfer Money">ØªØ­ÙˆÙŠÙ„ Ø£Ù…ÙˆØ§Ù„</h2>
            <form id="transferForm">
                <div class="form-group">
                    <label for="recipientEmail" data-ar="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…" data-en="Recipient Email">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                    <input type="email" id="recipientEmail" required>
                </div>
                <div class="form-group">
                    <label for="transferAmount" data-ar="Ø§Ù„Ù…Ø¨Ù„Øº" data-en="Amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input type="number" id="transferAmount" min="1" required>
                </div>
                <div class="form-group">
                    <label for="transferNote" data-ar="Ù…Ù„Ø§Ø­Ø¸Ø©" data-en="Note">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                    <input type="text" id="transferNote">
                </div>
                <button type="submit" data-ar="ØªØ­ÙˆÙŠÙ„" data-en="Transfer">ØªØ­ÙˆÙŠÙ„</button>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <span class="close-modal" id="closeHistoryModal">&times;</span>
            <h2 data-ar="Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" data-en="Transaction History">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <div id="fullTransactionsList">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
// Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØªÙ‡ Ù‚Ø¨Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", function() {
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAT0VfDrqizMR3y0QGmZc3WAzRGZ1xTcGo",
        authDomain: "mqrbank-e0c06.firebaseapp.com",
        projectId: "mqrbank-e0c06",
        storageBucket: "mqrbank-e0c06.firebasestorage.app",
        messagingSenderId: "677309991252",
        appId: "1:677309991252:web:abc8e543219fb24856e0c1"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    firebase.initializeApp(firebaseConfig);
    
    // ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø§Øª Firebase
    const db = firebase.firestore();
    const auth = firebase.auth();

// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Firebase
db.enablePersistence({ synchronizeTabs: true })
  .then(() => {
    console.log("ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©");
  })
  .catch((err) => {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ©:", err);
  });

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firestore
firebase.firestore().enableNetwork()
  .then(() => {
    console.log("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firestore");
  });

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
function initNetworkMonitoring() {
  const connectedRef = firebase.database().ref(".info/connected");
  connectedRef.on("value", (snap) => {
    if (snap.val() === true) {
      console.log("Ù…ØªØµÙ„ Ø¨Ù€ Firebase");
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
      const uid = sessionStorage.getItem("currentUserUid");
      if (uid) {
        reloadUserData(uid);
      }
    } else {
      console.log("ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ Firebase");
      // ÙŠÙ…ÙƒÙ† Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§
      const notification = document.createElement("div");
      notification.className = "notification offline-notification";
      notification.textContent = document.documentElement.lang === "ar" ? 
        "Ø£Ù†Øª Ø­Ø§Ù„ÙŠÙ‹Ø§ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„." :
        "You are currently offline. Operations will be stored locally and synced when connection is restored.";
      document.body.appendChild(notification);
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 5000);
    }
  });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function reloadUserData(uid) {
  db.collection("users").doc(uid).get()
    .then(doc => {
      if (doc.exists) {
        const userData = doc.data();
        loadUserData({
          name: userData.name,
          email: userData.email,
          balance: userData.balance,
          cardNumber: userData.cardNumber,
          uid: uid
        });
      }
    })
    .catch(error => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
    });
}



// Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯
function initAuthPersistence() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    const savedEmail = localStorage.getItem("userEmail");
    const savedUid = localStorage.getItem("userUid");
    
    if (savedEmail && savedUid) {
        console.log("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§:", savedEmail);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        const loadingMessage = document.createElement("div");
        loadingMessage.className = "loading-message";
        loadingMessage.textContent = document.documentElement.lang === "ar" ? 
            "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©..." : "Restoring your session...";
        document.body.appendChild(loadingMessage);
        
        // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„
        const currentUser = auth.currentUser;
        if (currentUser) {
            console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„:", currentUser.email);
            document.body.removeChild(loadingMessage);
        } else {
            console.log("Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...");
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
            // Ù‡Ø°Ø§ Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
            // Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù…Ø² Ù…Ù…ÙŠØ² Ù„Ù„ØªØ°ÙƒØ± (Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡ Ù‡Ù†Ø§)
        }
    }
}


    // DOM Elements
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const dashboard = document.getElementById("dashboard");
    const showRegisterLink = document.getElementById("showRegister");
    const showLoginLink = document.getElementById("showLogin");
    const logoutBtn = document.getElementById("logoutBtn");
    const userNameDisplay = document.getElementById("userNameDisplay");
    const balanceAmount = document.getElementById("balanceAmount");
    const cardHolderName = document.getElementById("cardHolderName");
    const lastFourDigits = document.getElementById("lastFourDigits");
    const depositBtn = document.getElementById("depositBtn");
    const transferBtn = document.getElementById("transferBtn");
    const walletsBtn = document.getElementById("walletsBtn");
    const historyBtn = document.getElementById("historyBtn");
    const depositModal = document.getElementById("depositModal");
    const transferModal = document.getElementById("transferModal");
    const historyModal = document.getElementById("historyModal");
    const closeDepositModal = document.getElementById("closeDepositModal");
    const closeTransferModal = document.getElementById("closeTransferModal");
    const closeHistoryModal = document.getElementById("closeHistoryModal");
    const depositForm = document.getElementById("depositForm");
    const transferForm = document.getElementById("transferForm");
    const transactionsList = document.getElementById("transactionsList");
    const fullTransactionsList = document.getElementById("fullTransactionsList");
    const tabs = document.querySelectorAll(".tab");
    const tabPanes = document.querySelectorAll(".tab-pane");
    const btcBalance = document.getElementById("btcBalance");
    const ethBalance = document.getElementById("ethBalance");
    const btcAddress = document.getElementById("btcAddress");
    const ethAddress = document.getElementById("ethAddress");

    // Ù„Ù†Ø¶ÙŠÙ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­
    console.log("DOM Elements:", {
        loginForm: loginForm ? "Found" : "Not Found",
        registerForm: registerForm ? "Found" : "Not Found",
        dashboard: dashboard ? "Found" : "Not Found"
    });

    // Event Listeners
    document.getElementById("login").addEventListener("submit", handleLogin);
    document.getElementById("register").addEventListener("submit", handleRegister);
    showRegisterLink.addEventListener("click", toggleForms);
    showLoginLink.addEventListener("click", toggleForms);
    logoutBtn.addEventListener("click", handleLogout);
    depositBtn.addEventListener("click", () => depositModal.style.display = "flex");
    transferBtn.addEventListener("click", () => transferModal.style.display = "flex");
    historyBtn.addEventListener("click", () => {
        loadFullTransactionHistory();
        historyModal.style.display = "flex";
    });
    closeDepositModal.addEventListener("click", () => depositModal.style.display = "none");
    closeTransferModal.addEventListener("click", () => transferModal.style.display = "none");
    closeHistoryModal.addEventListener("click", () => historyModal.style.display = "none");
    depositForm.addEventListener("submit", handleDeposit);
    transferForm.addEventListener("submit", handleTransfer);

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            const tabId = tab.getAttribute("data-tab");
            
            // Remove active class from all tabs and panes
            tabs.forEach(t => t.classList.remove("active"));
            tabPanes.forEach(p => p.classList.remove("active"));
            
            // Add active class to current tab and pane
            tab.classList.add("active");
            document.getElementById(tabId).classList.add("active");
        });
    });

    auth.onAuthStateChanged(user => {
    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const loadingMessage = document.querySelector(".loading-message");
    if (loadingMessage) {
        document.body.removeChild(loadingMessage);
    }

    console.log("ØªØºÙŠØ±Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", user);
    if (user) {
        // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©
        localStorage.setItem("userEmail", user.email);
        localStorage.setItem("userUid", user.uid);
        sessionStorage.setItem("currentUserUid", user.uid);
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore
        console.log("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore");
        db.collection("users").doc(user.uid).get()
            .then(doc => {
                console.log("ØªÙ… Ø¬Ù„Ø¨ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", doc.exists ? "Ù…ÙˆØ¬ÙˆØ¯Ø©" : "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
                if (doc.exists) {
                    const userData = doc.data();
                    console.log("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", userData);
                    loadUserData({
                        name: userData.name,
                        email: user.email,
                        balance: userData.balance,
                        cardNumber: userData.cardNumber,
                        uid: user.uid
                    });
                } else {
                    console.log("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©");
                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                    const cardNumber = generateCardNumber();
                    return db.collection("users").doc(user.uid).set({
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        balance: 0,
                        cardNumber: cardNumber,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        console.log("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©");
                        createDefaultWallets(user.uid);
                        loadUserData({
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            balance: 0,
                            cardNumber: cardNumber,
                            uid: user.uid
                        });
                    });
                }
            })
            .catch(error => {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                try {
                    const cachedUserData = JSON.parse(localStorage.getItem("userData"));
                    if (cachedUserData && cachedUserData.uid === user.uid) {
                        console.log("Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§:", cachedUserData);
                        loadUserData(cachedUserData);
                        alert(document.documentElement.lang === "ar" ? 
                              "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§. Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ù…Ø­Ø¯Ø«Ø©." : 
                              "Loaded cached data. Some information may not be up to date.");
                    } else {
                        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
                    }
                } catch (e) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§:", e);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
                }
            });
    } else {
        // Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        localStorage.removeItem("userEmail");
        localStorage.removeItem("userUid");
        sessionStorage.removeItem("currentUserUid");
        
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        if (dashboard) dashboard.style.display = "none";
        if (loginForm) loginForm.style.display = "block";
        if (registerForm) registerForm.style.display = "none";
    }
});
    // Functions
    function toggleForms(e) {
        e.preventDefault();
        loginForm.style.display = loginForm.style.display === "none" ? "block" : "none";
        registerForm.style.display = registerForm.style.display === "none" ? "block" : "none";
    }

    function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById("registerName").value;
    const email = document.getElementById("registerEmail").value;
    const password = document.getElementById("registerPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    
    if (password !== confirmPassword) {
        alert(document.documentElement.lang === "ar" ? "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©" : "Passwords do not match");
        return;
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
    let loadingMessage = document.createElement('div');
    loadingMessage.textContent = document.documentElement.lang === "ar" ? "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨..." : "Creating account...";
    loadingMessage.style.textAlign = "center";
    loadingMessage.style.padding = "10px";
    registerForm.appendChild(loadingMessage);
    
    // Create user with Firebase Auth
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("User registered successfully:", userCredential.user);

            // Create user document in Firestore
            const user = userCredential.user;
            const cardNumber = generateCardNumber();
            
            return db.collection("users").doc(user.uid).set({
                name: name,
                email: email,
                balance: 0,
                cardNumber: cardNumber,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Create default wallets for the user
                return createDefaultWallets(user.uid);
            })
            .then(() => {
                registerForm.removeChild(loadingMessage);
                alert(document.documentElement.lang === "ar" ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­" : "Account created successfully");
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById("registerName").value = "";
                document.getElementById("registerEmail").value = "";
                document.getElementById("registerPassword").value = "";
                document.getElementById("confirmPassword").value = "";
                // Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                loginForm.style.display = "block";
                registerForm.style.display = "none";
            });
        })
        .catch((error) => {
            registerForm.removeChild(loadingMessage);
            console.error("Error creating user: ", error);
            alert(error.message);
        });
}
function handleLogin(e) {
    e.preventDefault();
    console.log("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
    
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    
    console.log("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:", email);
    
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
    let loadingMessage = document.createElement('div');
    loadingMessage.textContent = document.documentElement.lang === "ar" ? "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„..." : "Logging in...";
    loadingMessage.style.textAlign = "center";
    loadingMessage.style.padding = "10px";
    loginForm.appendChild(loadingMessage);
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Auth
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­
            console.log("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­:", userCredential.user);
            document.getElementById("loginEmail").value = "";
            document.getElementById("loginPassword").value = "";
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            loginForm.removeChild(loadingMessage);
            
            // Ù„Ù† Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ù‡Ù†Ø§ Ù„Ø£Ù† onAuthStateChanged Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ
        })
        .catch((error) => {
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            loginForm.removeChild(loadingMessage);
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
            alert(document.documentElement.lang === "ar" ? "Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©" : "Invalid email or password");
        });
}

    function handleLogout() {
        auth.signOut()
            .then(() => {
                dashboard.style.display = "none";
                loginForm.style.display = "block";
            })
            .catch((error) => {
                console.error("Error signing out: ", error);
            });
    }

// Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
function syncPendingOperations() {
    if (!navigator.onLine) {
        console.log("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
        return Promise.resolve();
    }
    
    const pendingOperations = JSON.parse(localStorage.getItem("pendingOperations") || "[]");
    if (pendingOperations.length === 0) {
        console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©");
        return Promise.resolve();
    }
    
    console.log("Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:", pendingOperations.length);
    
    const promises = pendingOperations.map((operation, index) => {
        console.log(`Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ${index + 1}/${pendingOperations.length}:`, operation);
        
        if (operation.type === "deposit") {
            const userUid = operation.userUid;
            const amount = operation.amount;
            const userRef = db.collection("users").doc(userUid);
            
            return db.runTransaction((transaction) => {
                return transaction.get(userRef).then((userDoc) => {
                    if (!userDoc.exists) {
                        throw "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!";
                    }
                    
                    const userData = userDoc.data();
                    const newBalance = userData.balance + amount;
                    
                    transaction.update(userRef, { balance: newBalance });
                    
                    return { newBalance, index };
                });
            })
            .then(({ newBalance, index }) => {
                return addTransaction(userUid, "deposit", amount, null, "Ø¹Ù…Ù„ÙŠØ© Ù…ØªØ²Ø§Ù…Ù†Ø©")
                    .then(() => {
                        console.log(`ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø±Ù‚Ù… ${index + 1} Ø¨Ù†Ø¬Ø§Ø­`);
                        return index;
                    });
            });
        } else if (operation.type === "transfer") {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ù‡Ù†Ø§
            console.log("Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§");
            return Promise.resolve(index);
        }
        
        return Promise.resolve(index);
    });
    
    return Promise.all(promises)
        .then((completedIndices) => {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            const newPendingOperations = pendingOperations.filter((_, index) => !completedIndices.includes(index));
            localStorage.setItem("pendingOperations", JSON.stringify(newPendingOperations));
            
            console.log(`ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${completedIndices.length} Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ØŒ ØªØ¨Ù‚Ù‰ ${newPendingOperations.length} Ø¹Ù…Ù„ÙŠØ© Ù…Ø¹Ù„Ù‚Ø©`);
            
            if (completedIndices.length > 0) {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                const userUid = sessionStorage.getItem("currentUserUid");
                if (userUid) {
                    reloadUserData(userUid);
                }
            }
            
            return completedIndices.length;
        })
        .catch((error) => {
            console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:", error);
            return 0;
        });
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
window.addEventListener('online', () => {
    console.log("ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
    syncPendingOperations().then((count) => {
        if (count > 0) {
            alert(document.documentElement.lang === "ar" ? 
                  `ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${count} Ø¹Ù…Ù„ÙŠØ© Ù…Ø¹Ù„Ù‚Ø©` : 
                  `Successfully synced ${count} pending operations`);
        }
    });
});

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© loadUserData Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
function loadUserData(user) {
    console.log("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", user);
    
    // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„
    localStorage.setItem("userData", JSON.stringify(user));
    
    if (userNameDisplay) userNameDisplay.textContent = user.name;
    if (balanceAmount) balanceAmount.textContent = user.balance.toLocaleString();
    if (cardHolderName) cardHolderName.textContent = user.name;
    if (lastFourDigits) lastFourDigits.textContent = user.cardNumber.slice(-4);
    
    // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
    sessionStorage.setItem("currentUserUid", user.uid);
    localStorage.setItem("userEmail", user.email);
    localStorage.setItem("userUid", user.uid);
    
    loadRecentTransactions(user.uid);
    loadWalletBalances(user.uid);
    
    if (loginForm) loginForm.style.display = "none";
    if (registerForm) registerForm.style.display = "none";
    if (dashboard) {
        dashboard.style.display = "block";
        console.log("ØªÙ… Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…");
    } else {
        console.error("Ø¹Ù†ØµØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
    }

    // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    if (navigator.onLine) {
        syncPendingOperations();
    }
    
    console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ… Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…");
}

function handleDeposit(e) {
    e.preventDefault();
    
    const amount = parseFloat(document.getElementById("depositAmount").value);
    if (isNaN(amount) || amount <= 0) {
        alert(document.documentElement.lang === "ar" ? "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­" : "Please enter a valid amount");
        return;
    }
    
    const userUid = sessionStorage.getItem("currentUserUid");
    if (!userUid) {
        alert(document.documentElement.lang === "ar" ? "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹" : "Please login first");
        return;
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const loadingIndicator = document.createElement("div");
    loadingIndicator.className = "loading-indicator";
    loadingIndicator.textContent = document.documentElement.lang === "ar" ? "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹..." : "Processing deposit...";
    depositModal.appendChild(loadingIndicator);
    
    const userRef = db.collection("users").doc(userUid);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹
    const isOnline = window.navigator.onLine;
    console.log("Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª:", isOnline ? "Ù…ØªØµÙ„" : "ØºÙŠØ± Ù…ØªØµÙ„");
    
    if (!isOnline) {
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ù‚Ù… Ø¨ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
        storePendingDeposit(userUid, amount);
        depositModal.removeChild(loadingIndicator);
        depositModal.style.display = "none";
        document.getElementById("depositAmount").value = "";
        
        alert(document.documentElement.lang === "ar" ? 
              "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ³ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„" : 
              "Deposit saved locally and will be synced when connection is restored");
        return;
    }
    
    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firestore Ø£ÙˆÙ„Ø§Ù‹
    db.collection("_test_connection").doc("test")
        .set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() })
        .then(() => {
            // Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹Ù…Ù„ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹
            processDeposit(userUid, amount, loadingIndicator);
        })
        .catch((error) => {
            console.error("ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firestore:", error);
            
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
            storePendingDeposit(userUid, amount);
            
            depositModal.removeChild(loadingIndicator);
            depositModal.style.display = "none";
            document.getElementById("depositAmount").value = "";
            
            alert(document.documentElement.lang === "ar" ? 
                  "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ³ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡ Ù„Ø§Ø­Ù‚Ù‹Ø§." : 
                  "Server connection failed. Deposit saved locally and will be synced later.");
        });
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
function processDeposit(userUid, amount, loadingIndicator) {
    const userRef = db.collection("users").doc(userUid);
    
    db.runTransaction((transaction) => {
        return transaction.get(userRef).then((userDoc) => {
            if (!userDoc.exists) {
                throw "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!";
            }
            
            const userData = userDoc.data();
            const newBalance = userData.balance + amount;
            
            transaction.update(userRef, { balance: newBalance });
            
            return newBalance;
        });
    })
    .then((newBalance) => {
        return addTransaction(userUid, "deposit", amount, null, null)
            .then(() => {
                balanceAmount.textContent = newBalance.toLocaleString();
                
                depositModal.removeChild(loadingIndicator);
                depositModal.style.display = "none";
                document.getElementById("depositAmount").value = "";
                
                alert(document.documentElement.lang === "ar" ? "ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­" : "Deposit successful");
                
                loadRecentTransactions(userUid);
            });
    })
    .catch((error) => {
        console.error("ÙØ´Ù„Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ", error);
        depositModal.removeChild(loadingIndicator);
        
        // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹
        alert(document.documentElement.lang === "ar" ? 
              `ÙØ´Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹: ${error.code || error}` : 
              `Deposit failed: ${error.code || error}`);
        
        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
        storePendingDeposit(userUid, amount);
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù‚
function storePendingDeposit(userUid, amount) {
    try {
        const pendingOperations = JSON.parse(localStorage.getItem("pendingOperations") || "[]");
        pendingOperations.push({
            type: "deposit",
            amount: amount,
            userUid: userUid,
            timestamp: Date.now()
        });
        localStorage.setItem("pendingOperations", JSON.stringify(pendingOperations));
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚ØªÙ‹Ø§
        const currentBalance = parseFloat(balanceAmount.textContent.replace(/,/g, "")) || 0;
        balanceAmount.textContent = (currentBalance + amount).toLocaleString();
        
        console.log("ØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù‚ Ø¨Ù†Ø¬Ø§Ø­");
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø­Ù„ÙŠÙ‹Ø§:", e);
    }
}

function handleTransfer(e) {
        e.preventDefault();
        
        const recipientEmail = document.getElementById("recipientEmail").value;
        const amount = parseFloat(document.getElementById("transferAmount").value);
        const note = document.getElementById("transferNote").value;
        
        if (isNaN(amount) || amount <= 0) {
            alert(document.documentElement.lang === "ar" ? "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­" : "Please enter a valid amount");
            return;
        }
        
        const senderUid = sessionStorage.getItem("currentUserUid");
        
        // Get sender's current balance
        db.collection("users").doc(senderUid).get()
            .then(doc => {
                if (!doc.exists) {
                    throw "Sender does not exist!";
                }
                
                const senderData = doc.data();
                
                if (senderData.balance < amount) {
                    alert(document.documentElement.lang === "ar" ? "Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ" : "Insufficient balance");
                    return;
                }
                
                // Find recipient by email
                return db.collection("users").where("email", "==", recipientEmail).get();
            })
            .then(querySnapshot => {
                if (querySnapshot.empty) {
                    alert(document.documentElement.lang === "ar" ? "Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" : "Recipient not found");
                    throw "Recipient not found";
                }
                
                // Get recipient document
                const recipientDoc = querySnapshot.docs[0];
                const recipientUid = recipientDoc.id;
                
                // Use batch write to ensure both operations occur
                const batch = db.batch();
                
                // Update sender balance
                const senderRef = db.collection("users").doc(senderUid);
                batch.update(senderRef, {
                    balance: firebase.firestore.FieldValue.increment(-amount)
                });
                
                // Update recipient balance
                const recipientRef = db.collection("users").doc(recipientUid);
                batch.update(recipientRef, {
                    balance: firebase.firestore.FieldValue.increment(amount)
                });
                
                // Commit the batch
                return batch.commit().then(() => {
                    return {
                        senderUid,
                        recipientUid,
                        recipientEmail
                    };
                });
            })
            .then(({senderUid, recipientUid, recipientEmail}) => {
                // Add transaction records
                addTransaction(senderUid, "sent", amount, recipientEmail, note);
                addTransaction(recipientUid, "received", amount, auth.currentUser.email, note);
                
                // Get updated sender data
                return db.collection("users").doc(senderUid).get();
            })
            .then(doc => {
                const userData = doc.data();
                
                // Update UI
                balanceAmount.textContent = userData.balance.toLocaleString();
                
                // Close modal and reset form
                transferModal.style.display = "none";
                document.getElementById("recipientEmail").value = "";
                document.getElementById("transferAmount").value = "";
                document.getElementById("transferNote").value = "";
                
                alert(document.documentElement.lang === "ar" ? "ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­" : "Transfer successful");
                
                // Reload transactions
                loadRecentTransactions(senderUid);
            })
            .catch((error) => {
                if (error !== "Recipient not found") {
                    console.error("Transfer failed: ", error);
                    alert(error);
                }
            });
    }


// Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase
function setupReconnectionHandler() {
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectInterval = 5000; // 5 Ø«ÙˆØ§Ù†Ù
    
    let reconnectTimer = null;
    
    const attemptReconnect = () => {
        if (!navigator.onLine) {
            console.log("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„: Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
            return;
        }
        
        if (reconnectAttempts >= maxReconnectAttempts) {
            console.log("ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„");
            clearInterval(reconnectTimer);
            alert(document.documentElement.lang === "ar" ? 
                  "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰." : 
                  "Unable to connect to server. Please refresh the page and try again.");
            return;
        }
        
        reconnectAttempts++;
        console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ${reconnectAttempts}/${maxReconnectAttempts}...`);
        
        firebase.firestore().enableNetwork()
            .then(() => {
                console.log("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firestore Ø¨Ù†Ø¬Ø§Ø­");
                clearInterval(reconnectTimer);
                reconnectAttempts = 0;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const userUid = sessionStorage.getItem("currentUserUid");
                if (userUid) {
                    reloadUserData(userUid);
                }
                
                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
                syncPendingOperations();
            })
            .catch((error) => {
                console.error("ÙØ´Ù„Øª Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„:", error);
            });
    };
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    firebase.firestore().onSnapshotsInSync(() => {
        console.log("Firestore Ù…ØªØ²Ø§Ù…Ù†");
    });
    
    window.addEventListener('online', () => {
        console.log("ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
        attemptReconnect();
    });
    
    window.addEventListener('offline', () => {
        console.log("ØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
        if (reconnectTimer) {
            clearInterval(reconnectTimer);
        }
    });
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase
    db.collection("users").onSnapshot({
        error: (error) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
            
            if (error.code === 'unavailable' || error.code === 'resource-exhausted') {
                console.log("Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...");
                if (!reconnectTimer) {
                    reconnectTimer = setInterval(attemptReconnect, reconnectInterval);
                }
            }
        }
    });
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Firebase
setupReconnectionHandler();

    function addTransaction(userUid, type, amount, otherParty, note) {
        return db.collection("transactions").add({
            userUid,
            type,
            amount,
            otherParty,
            note,
            date: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    function loadRecentTransactions(userUid) {
        db.collection("transactions")
            .where("userUid", "==", userUid)
            .orderBy("date", "desc")
            .limit(5)
            .get()
            .then(querySnapshot => {
                if (querySnapshot.empty) {
                    transactionsList.innerHTML = `
                        <div class="transaction-item">
                            <div>
                                <strong data-ar="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª" data-en="No transactions yet">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</strong>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                transactionsList.innerHTML = "";
                
                querySnapshot.forEach(doc => {
                    const tx = doc.data();
                    const date = tx.date ? tx.date.toDate() : new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                    
                    const transactionItem = document.createElement("div");
                    transactionItem.className = "transaction-item";
                    
                    let typeText, amountHTML;
                    
                    if (tx.type === "deposit") {
                        typeText = document.documentElement.lang === "ar" ? "Ø¥ÙŠØ¯Ø§Ø¹" : "Deposit";
                        amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                    } else if (tx.type === "sent") {
                        typeText = document.documentElement.lang === "ar" ? "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰" : "Transfer to";
                        typeText += ` ${tx.otherParty}`;
                        amountHTML = `<span style="color: red;">-${tx.amount.toLocaleString()}</span>`;
                    } else if (tx.type === "received") {
                        typeText = document.documentElement.lang === "ar" ? "Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†" : "Received from";
                        typeText += ` ${tx.otherParty}`;
                        amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                    }
                    
                    transactionItem.innerHTML = `
                        <div>
                            <strong>${typeText}</strong>
                            <div>${formattedDate}</div>
                            ${tx.note ? `<div><small>${tx.note}</small></div>` : ''}
                        </div>
                        <div>
                            ${amountHTML}
                        </div>
                    `;
                    
                    transactionsList.appendChild(transactionItem);
                });
            })
            .catch(error => {
                console.error("Error loading transactions: ", error);
                transactionsList.innerHTML = `
                    <div class="transaction-item">
                        <div>
                            <strong>Error loading transactions</strong>
                        </div>
                    </div>
                `;
            });
    }

    function loadFullTransactionHistory() {
        const userUid = sessionStorage.getItem("currentUserUid");
        
        db.collection("transactions")
            .where("userUid", "==", userUid)
            .orderBy("date", "desc")
            .get()
            .then(querySnapshot => {
                if (querySnapshot.empty) {
                    fullTransactionsList.innerHTML = `
                        <div class="transaction-item">
                            <div>
                                <strong data-ar="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª" data-en="No transactions yet">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</strong>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                fullTransactionsList.innerHTML = "";
                
                querySnapshot.forEach(doc => {
                    const tx = doc.data();
                    const date = tx.date ? tx.date.toDate() : new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    const transactionItem = document.createElement("div");
                    transactionItem.className = "transaction-item";
                    
                    let typeText, amountHTML;
                    
                    if (tx.type === "deposit") {
                        typeText = document.documentElement.lang === "ar" ? "Ø¥ÙŠØ¯Ø§Ø¹" : "Deposit";
                        amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                    } else if (tx.type === "sent") {
                        typeText = document.documentElement.lang === "ar" ? "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰" : "Transfer to";
                        typeText += ` ${tx.otherParty}`;
                        amountHTML = `<span style="color: red;">-${tx.amount.toLocaleString()}</span>`;
                    } else if (tx.type === "received") {
                        typeText = document.documentElement.lang === "ar" ? "Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†" : "Received from";
                        typeText += ` ${tx.otherParty}`;
                        amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                    }
                    
                    transactionItem.innerHTML = `
                        <div>
                            <strong>${typeText}</strong>
                            <div>${formattedDate}</div>
                            ${tx.note ? `<div><small>${tx.note}</small></div>` : ''}
                        </div>
                        <div>
                            ${amountHTML}
                        </div>
                    `;
                    
                    fullTransactionsList.appendChild(transactionItem);
                });
            })
            .catch(error => {
                console.error("Error loading transaction history: ", error);
            });
    }

    function createDefaultWallets(userUid) {
    const batch = db.batch();
    
    // Bitcoin wallet ref
    const btcWalletRef = db.collection("wallets").doc(`${userUid}_BTC`);
    batch.set(btcWalletRef, {
        userUid,
        type: "BTC",
        balance: 0,
        address: generateWalletAddress("BTC"),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Ethereum wallet ref
    const ethWalletRef = db.collection("wallets").doc(`${userUid}_ETH`);
    batch.set(ethWalletRef, {
        userUid,
        type: "ETH",
        balance: 0,
        address: generateWalletAddress("ETH"),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Return the batch commit promise
    return batch.commit().then(() => {
        console.log("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©");
    });
}
    function loadWalletBalances(userUid) {
        db.collection("wallets")
            .where("userUid", "==", userUid)
            .get()
            .then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    const wallet = doc.data();
                    
                    if (wallet.type === "BTC") {
                        btcBalance.textContent = wallet.balance;
                        btcAddress.textContent = wallet.address;
                    } else if (wallet.type === "ETH") {
                        ethBalance.textContent = wallet.balance;
                        ethAddress.textContent = wallet.address;
                    }
                });
            })
            .catch(error => {
                console.error("Error loading wallets: ", error);
            });
    }

    function generateCardNumber() {
        let cardNumber = "4";
        for (let i = 0; i < 15; i++) {
            cardNumber += Math.floor(Math.random() * 10);
        }
        return cardNumber;
    }

    function generateWalletAddress(type) {
        if (type === "BTC") {
            const prefix = "bc1";
            let address = prefix;
            const chars = "qwertyuiopasdfghjklzxcvbnm1234567890";
            for (let i = 0; i < 35; i++) {
                address += chars[Math.floor(Math.random() * chars.length)];
            }
            return address;
        } else if (type === "ETH") {
            const prefix = "0x";
            let address = prefix;
            const chars = "abcdef1234567890";
            for (let i = 0; i < 40; i++) {
                address += chars[Math.floor(Math.random() * chars.length)];
            }
            return address;
        }
        return "";
    }

    function checkFirebaseConnection() {
    return new Promise((resolve, reject) => {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        const testRef = db.collection("_connection_test").doc("test");
        testRef.set({
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            console.log("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase Ø¨Ù†Ø¬Ø§Ø­");
            resolve(true);
        })
        .catch((error) => {
            console.error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase:", error);
            reject(error);
        });
    });
}

    // Language toggle
    window.toggleLanguage = function() {
        const currentLang = document.body.classList.contains("rtl") ? "ar" : "en";
        const newLang = currentLang === "ar" ? "en" : "ar";
        
        if (newLang === "en") {
            document.body.classList.remove("rtl");
            document.body.classList.add("ltr");
            document.documentElement.lang = "en";
            document.querySelector(".language-toggle").textContent = "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
        } else {
            document.body.classList.remove("ltr");
            document.body.classList.add("rtl");
            document.documentElement.lang = "ar";
            document.querySelector(".language-toggle").textContent = "English";
        }
        
        // Update all elements with data-ar and data-en attributes
        const elements = document.querySelectorAll("[data-ar][data-en]");
        elements.forEach(el => {
            el.textContent = el.getAttribute(`data-${newLang}`);
        });
    };

    // Window click event to close modals when clicking outside
    window.onclick = function(event) {
        if (event.target === depositModal) {
            depositModal.style.display = "none";
        }
        if (event.target === transferModal) {
            transferModal.style.display = "none";
        }
        if (event.target === historyModal) {
            historyModal.style.display = "none";
        }
    };
});   </script>
</body>
</html>