<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANK GAME</title>
<!-- Firebase App (القاعدة) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

<!-- خدمات Firebase إضافية -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        :root {
            --primary-color: #000;
            --secondary-color: #fff;
            --accent-color: #333;
            --text-color: #000;
            --background-color: #fff;
            --border-color: #ddd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        .rtl {
            direction: rtl;
            text-align: right;
        }

        .ltr {
            direction: ltr;
            text-align: left;
        }

        header {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            color: var(--secondary-color);
        }

        .language-toggle {
            background: transparent;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .login-container, .register-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .balance {
            font-size: 2rem;
            font-weight: bold;
        }

        .currency {
            font-size: 0.8rem;
            color: #777;
        }

        .card {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .card-number {
            font-size: 1.2rem;
            letter-spacing: 4px;
            margin: 1rem 0;
        }

        .card-holder {
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .card-expiry {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            font-size: 0.8rem;
        }

        body.rtl .card-expiry {
  position: absolute;
  bottom: 20px;
  left: 20px;
  right: auto;
}

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .action-item {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .transactions {
            margin-top: 2rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        form {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--accent-color);
        }

        .wallet-container {
            margin-top: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .wallet-address {
            font-family: monospace;
            padding: 0.5rem;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin: 0.5rem 0;
            word-break: break-all;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--background-color);
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .tab-container {
            margin-top: 2rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            padding: 1.5rem 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="rtl">
    <header>
        <a href="#" class="logo">BANK GAME</a>
        <button class="language-toggle" onclick="toggleLanguage()">English</button>
    </header>

    <div class="container">
        <!-- Login Form -->
        <div class="login-container" id="loginForm">
            <h2 data-ar="تسجيل الدخول" data-en="Login">تسجيل الدخول</h2>
            <form id="login">
                <div class="form-group">
                    <label for="loginEmail" data-ar="البريد الإلكتروني" data-en="Email">البريد الإلكتروني</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword" data-ar="كلمة المرور" data-en="Password">كلمة المرور</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" data-ar="دخول" data-en="Login">دخول</button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                <a href="#" id="showRegister" data-ar="لا تملك حساب؟ سجل الآن" data-en="Don't have an account? Register now">لا تملك حساب؟ سجل الآن</a>
            </p>
        </div>

        <!-- Register Form -->
        <div class="register-container" id="registerForm" style="display: none;">
            <h2 data-ar="إنشاء حساب جديد" data-en="Create New Account">إنشاء حساب جديد</h2>
            <form id="register">
                <div class="form-group">
                    <label for="registerName" data-ar="الاسم الكامل" data-en="Full Name">الاسم الكامل</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail" data-ar="البريد الإلكتروني" data-en="Email">البريد الإلكتروني</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword" data-ar="كلمة المرور" data-en="Password">كلمة المرور</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword" data-ar="تأكيد كلمة المرور" data-en="Confirm Password">تأكيد كلمة المرور</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <button type="submit" data-ar="تسجيل" data-en="Register">تسجيل</button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                <a href="#" id="showLogin" data-ar="لديك حساب بالفعل؟ تسجيل الدخول" data-en="Already have an account? Login">لديك حساب بالفعل؟ تسجيل الدخول</a>
            </p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <div>
                    <h2 data-ar="مرحباً، " data-en="Welcome, "><span id="userNameDisplay">مستخدم</span></h2>
                </div>
                <button id="logoutBtn" data-ar="تسجيل الخروج" data-en="Logout">تسجيل الخروج</button>
            </div>

            <div class="card">
                <h3 data-ar="بطاقة الائتمان" data-en="Credit Card">بطاقة الائتمان</h3>
                <div class="card-number">**** **** **** <span id="lastFourDigits">1234</span></div>
                <div class="card-holder" id="cardHolderName">اسم صاحب البطاقة</div>
                <div class="card-expiry">12/28</div>
            </div>

            <div class="balance-section">
                <h3 data-ar="الرصيد الحالي" data-en="Current Balance">الرصيد الحالي</h3>
                <div class="balance"><span id="balanceAmount">0</span> <span class="currency" data-ar="ريال" data-en="SAR">ريال</span></div>
            </div>
            <div style="margin-top: 1rem;">
                <strong data-ar="باي بان:" data-en="PayBan:">باي بان:</strong>
                <div id="paybanDisplay" style="font-family: monospace; background: #f5f5f5; padding: 0.5rem; border-radius: 4px;"></div>
            </div>
            
            <div class="actions">
                <div class="action-item" id="depositBtn">
                    <div class="action-icon">💰</div>
                    <h3 data-ar="إيداع" data-en="Deposit">إيداع</h3>
                </div>
                <div class="action-item" id="transferBtn">
                    <div class="action-icon">↗️</div>
                    <h3 data-ar="تحويل" data-en="Transfer">تحويل</h3>
                </div>
                <div class="action-item" id="walletsBtn">
                    <div class="action-icon">💼</div>
                    <h3 data-ar="المحافظ الرقمية" data-en="Digital Wallets">المحافظ الرقمية</h3>
                </div>
                <div class="action-item" id="historyBtn">
                    <div class="action-icon">📜</div>
                    <h3 data-ar="سجل العمليات" data-en="Transaction History">سجل العمليات</h3>
                </div>
            </div>

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="recent-transactions" data-ar="أحدث العمليات" data-en="Recent Transactions">أحدث العمليات</div>
                    <div class="tab" data-tab="wallets" data-ar="المحافظ" data-en="Wallets">المحافظ</div>
                </div>

                <div class="tab-content">
                    <div class="tab-pane active" id="recent-transactions">
                        <div class="transactions" id="transactionsList">
                            <div class="transaction-item">
                                <div>
                                    <strong data-ar="لا توجد معاملات" data-en="No transactions yet">لا توجد معاملات</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="wallets">
                        <div class="wallet-container">
                            <div class="wallet-header">
                                <h3>Bitcoin (BTC)</h3>
                                <div><span id="btcBalance">0</span> BTC</div>
                            </div>
                            <div>
                                <p data-ar="عنوان المحفظة:" data-en="Wallet Address:">عنوان المحفظة:</p>
                                <div class="wallet-address" id="btcAddress">bc1q87de3fagf7agfg78afg78ga78fg7a8g7</div>
                            </div>
                        </div>
                        
                        <div class="wallet-container">
                            <div class="wallet-header">
                                <h3>Ethereum (ETH)</h3>
                                <div><span id="ethBalance">0</span> ETH</div>
                            </div>
                            <div>
                                <p data-ar="عنوان المحفظة:" data-en="Wallet Address:">عنوان المحفظة:</p>
                                <div class="wallet-address" id="ethAddress">0x87de3f7agf7agfg78afg78ga78fg7a8g7</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <span class="close-modal" id="closeDepositModal">&times;</span>
            <h2 data-ar="إيداع أموال" data-en="Deposit Money">إيداع أموال</h2>
            <form id="depositForm">
                <div class="form-group">
                  <label for="depositType" data-ar="نوع الإيداع" data-en="Deposit Type">نوع الإيداع</label>
                  <select id="depositType" required>
                    <option value="bank" data-ar="رصيد بنكي" data-en="Bank">رصيد بنكي</option>
                    <option value="crypto" data-ar="عملات رقمية" data-en="Crypto">عملات رقمية</option>
                  </select>
                </div>
              
                <div class="form-group" id="bankDepositGroup">
                  <label for="depositAmount" data-ar="المبلغ" data-en="Amount">المبلغ</label>
                  <input type="number" id="depositAmount" min="1">
                </div>
              
                <div class="form-group" id="cryptoDepositGroup" style="display: none;">
                  <label for="cryptoType" data-ar="اختر العملة" data-en="Crypto Type">اختر العملة</label>
                  <select id="cryptoType">
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                  </select>

                  <div style="margin-top: 0.5rem;">
                    <small id="cryptoDollarPreview" style="color: #666;"></small>
                  </div>
                  
                  <label for="cryptoAmount" data-ar="المبلغ" data-en="Amount">المبلغ</label>
                  <input type="text" id="cryptoAmount" placeholder="مثال: 0.05">
                </div>
              
                <button type="submit" data-ar="إيداع" data-en="Submit">إيداع</button>
              </form>
                      </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <span class="close-modal" id="closeTransferModal">&times;</span>
            <h2 data-ar="تحويل أموال" data-en="Transfer Money">تحويل أموال</h2>
            <form id="transferForm">
                <div class="form-group">
                  <label for="transferType" data-ar="نوع التحويل" data-en="Transfer Type">نوع التحويل</label>
                  <select id="transferType" required>
                    <option value="bank" data-ar="بنكي (رصيد)" data-en="Bank">بنكي (رصيد)</option>
                    <option value="crypto" data-ar="عملة رقمية" data-en="Crypto">عملة رقمية</option>
                  </select>
                </div>
              
                <!-- تحويل بنكي -->
                <div id="bankTransferGroup">
                  <div class="form-group">
                    <label for="transferMethod" data-ar="طريقة التحويل" data-en="Transfer Method">طريقة التحويل</label>
                    <select id="transferMethod">
                      <option value="email" data-ar="البريد الإلكتروني" data-en="Email">البريد الإلكتروني</option>
                      <option value="username" data-ar="اسم المستخدم" data-en="Username">اسم المستخدم</option>
                      <option value="payban" data-ar="باي بان" data-en="PayBan">باي بان</option>
                    </select>
                  </div>
              
                  <div class="form-group">
                    <label for="recipientInput" data-ar="المستلم" data-en="Recipient">المستلم</label>
                    <input type="text" id="recipientInput">
                  </div>
              
                  <div class="form-group">
                    <label for="transferAmount" data-ar="المبلغ" data-en="Amount">المبلغ</label>
                    <input type="number" id="transferAmount" min="1">
                  </div>
                </div>
              
                <!-- تحويل عملة رقمية -->
                <div id="cryptoTransferGroup" style="display: none;">
                  <div class="form-group">
                    <label for="cryptoCurrency" data-ar="العملة الرقمية" data-en="Crypto Currency">العملة الرقمية</label>
                    <select id="cryptoCurrency">
                      <option value="BTC">Bitcoin (BTC)</option>
                      <option value="ETH">Ethereum (ETH)</option>
                    </select>
                  </div>
              
                  <div class="form-group">
                    <label for="cryptoRecipient" data-ar="عنوان المحفظة" data-en="Crypto Address">عنوان المحفظة</label>
                    <input type="text" id="cryptoRecipient" placeholder="مثل: bc1xyz أو 0xabc">
                  </div>
              
                  <div class="form-group">
                    <label for="cryptoTransferAmount" data-ar="المبلغ" data-en="Amount">المبلغ</label>
                    <input type="text" id="cryptoTransferAmount" placeholder="مثال: 0.05">
                  </div>
              
                  <div>
                    <small id="cryptoUSDPreview" style="color: #666;"></small>
                  </div>
                </div>
              
                <div class="form-group">
                  <label for="transferNote" data-ar="ملاحظة" data-en="Note">ملاحظة</label>
                  <input type="text" id="transferNote">
                </div>
              
                <button type="submit" data-ar="تحويل" data-en="Submit">تحويل</button>
              </form>
                            </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <span class="close-modal" id="closeHistoryModal">&times;</span>
            <h2 data-ar="سجل العمليات" data-en="Transaction History">سجل العمليات</h2>
            <div id="fullTransactionsList">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
// بداية الكود الذي يجب إضافته قبل باقي الكود في نهاية الصفحة
document.addEventListener("DOMContentLoaded", function() {
    // تهيئة Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAT0VfDrqizMR3y0QGmZc3WAzRGZ1xTcGo",
        authDomain: "mqrbank-e0c06.firebaseapp.com",
        projectId: "mqrbank-e0c06",
        storageBucket: "mqrbank-e0c06.firebasestorage.app",
        messagingSenderId: "677309991252",
        appId: "1:677309991252:web:abc8e543219fb24856e0c1"
    };

    // تهيئة Firebase
    firebase.initializeApp(firebaseConfig);
    
    // تهيئة خدمات Firebase
    const db = firebase.firestore();
    const auth = firebase.auth();

// أضف هذا الكود بعد تهيئة Firebase
db.enablePersistence({ synchronizeTabs: true })
  .then(() => {
    console.log("تم تفعيل وضع الاستمرارية المحلية");
  })
  .catch((err) => {
    console.error("خطأ في تفعيل وضع الاستمرارية:", err);
  });

// مراقبة حالة الاتصال بـ Firestore
firebase.firestore().enableNetwork()
  .then(() => {
    console.log("تم تفعيل الاتصال بـ Firestore");
  });

// إضافة مستمع لحالة الاتصال
function initNetworkMonitoring() {
  const connectedRef = firebase.database().ref(".info/connected");
  connectedRef.on("value", (snap) => {
    if (snap.val() === true) {
      console.log("متصل بـ Firebase");
      // محاولة إعادة تحميل بيانات المستخدم عند استعادة الاتصال
      const uid = sessionStorage.getItem("currentUserUid");
      if (uid) {
        reloadUserData(uid);
      }
    } else {
      console.log("غير متصل بـ Firebase");
      // يمكن إظهار إشعار للمستخدم هنا
      const notification = document.createElement("div");
      notification.className = "notification offline-notification";
      notification.textContent = document.documentElement.lang === "ar" ? 
        "أنت حاليًا غير متصل بالإنترنت. سيتم تخزين العمليات محليًا ومزامنتها عند استعادة الاتصال." :
        "You are currently offline. Operations will be stored locally and synced when connection is restored.";
      document.body.appendChild(notification);
      
      // إزالة الإشعار بعد 5 ثوانٍ
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 5000);
    }
  });
}

// دالة لإعادة تحميل بيانات المستخدم
function reloadUserData(uid) {
  db.collection("users").doc(uid).get()
    .then(doc => {
      if (doc.exists) {
        const userData = doc.data();
        loadUserData({
          name: userData.name,
          email: userData.email,
          balance: userData.balance,
          cardNumber: userData.cardNumber,
          uid: uid
        });
      }
    })
    .catch(error => {
      console.error("خطأ في إعادة تحميل بيانات المستخدم:", error);
    });
}



// إضافة هذه الدالة في بداية الكود
function initAuthPersistence() {
    // محاولة استعادة معلومات المستخدم من التخزين المحلي
    const savedEmail = localStorage.getItem("userEmail");
    const savedUid = localStorage.getItem("userUid");
    
    if (savedEmail && savedUid) {
        console.log("تم العثور على معلومات المستخدم المحفوظة محليًا:", savedEmail);
        
        // إظهار رسالة تحميل
        const loadingMessage = document.createElement("div");
        loadingMessage.className = "loading-message";
        loadingMessage.textContent = document.documentElement.lang === "ar" ? 
            "جاري استعادة الجلسة..." : "Restoring your session...";
        document.body.appendChild(loadingMessage);
        
        // تحقق مما إذا كان المستخدم مسجل دخوله بالفعل
        const currentUser = auth.currentUser;
        if (currentUser) {
            console.log("المستخدم مسجل دخوله بالفعل:", currentUser.email);
            document.body.removeChild(loadingMessage);
        } else {
            console.log("محاولة استعادة جلسة المستخدم...");
            // في حالة عدم وجود مستخدم حالي، يمكننا محاولة تسجيل الدخول تلقائيًا
            // هذا قد يتطلب أن يكون المستخدم قد حفظ كلمة المرور الخاصة به في المتصفح
            // أو يمكن استخدام رمز مميز للتذكر (لم يتم تنفيذه هنا)
        }
    }
}


    // DOM Elements
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const dashboard = document.getElementById("dashboard");
    const showRegisterLink = document.getElementById("showRegister");
    const showLoginLink = document.getElementById("showLogin");
    const logoutBtn = document.getElementById("logoutBtn");
    const userNameDisplay = document.getElementById("userNameDisplay");
    const balanceAmount = document.getElementById("balanceAmount");
    const cardHolderName = document.getElementById("cardHolderName");
    const lastFourDigits = document.getElementById("lastFourDigits");
    const depositBtn = document.getElementById("depositBtn");
    const transferBtn = document.getElementById("transferBtn");
    const walletsBtn = document.getElementById("walletsBtn");
    const historyBtn = document.getElementById("historyBtn");
    const depositModal = document.getElementById("depositModal");
    const transferModal = document.getElementById("transferModal");
    const historyModal = document.getElementById("historyModal");
    const closeDepositModal = document.getElementById("closeDepositModal");
    const closeTransferModal = document.getElementById("closeTransferModal");
    const closeHistoryModal = document.getElementById("closeHistoryModal");
    const depositForm = document.getElementById("depositForm");
    const transferForm = document.getElementById("transferForm");
    const transactionsList = document.getElementById("transactionsList");
    const fullTransactionsList = document.getElementById("fullTransactionsList");
    const tabs = document.querySelectorAll(".tab");
    const tabPanes = document.querySelectorAll(".tab-pane");
    const btcBalance = document.getElementById("btcBalance");
    const ethBalance = document.getElementById("ethBalance");
    const btcAddress = document.getElementById("btcAddress");
    const ethAddress = document.getElementById("ethAddress");
    const transferType = document.getElementById("transferType");
    const bankGroup = document.getElementById("bankTransferGroup");
    const cryptoGroup = document.getElementById("cryptoTransferGroup");


    // لنضيف المزيد من سجلات التصحيح
    console.log("DOM Elements:", {
        loginForm: loginForm ? "Found" : "Not Found",
        registerForm: registerForm ? "Found" : "Not Found",
        dashboard: dashboard ? "Found" : "Not Found"
    });


    transferType.addEventListener("change", () => {
  const type = transferType.value;
  bankGroup.style.display = type === "bank" ? "block" : "none";
  cryptoGroup.style.display = type === "crypto" ? "block" : "none";
});

    // Event Listeners
    document.getElementById("login").addEventListener("submit", handleLogin);
    document.getElementById("register").addEventListener("submit", handleRegister);
    showRegisterLink.addEventListener("click", toggleForms);
    showLoginLink.addEventListener("click", toggleForms);
    logoutBtn.addEventListener("click", handleLogout);
    depositBtn.addEventListener("click", () => depositModal.style.display = "flex");
    transferBtn.addEventListener("click", () => transferModal.style.display = "flex");
    historyBtn.addEventListener("click", () => {
        loadFullTransactionHistory();
        historyModal.style.display = "flex";
    });
    closeDepositModal.addEventListener("click", () => depositModal.style.display = "none");
    closeTransferModal.addEventListener("click", () => transferModal.style.display = "none");
    closeHistoryModal.addEventListener("click", () => historyModal.style.display = "none");
    depositForm.addEventListener("submit", handleDeposit);
    transferForm.addEventListener("submit", handleTransfer);

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            const tabId = tab.getAttribute("data-tab");
            
            // Remove active class from all tabs and panes
            tabs.forEach(t => t.classList.remove("active"));
            tabPanes.forEach(p => p.classList.remove("active"));
            
            // Add active class to current tab and pane
            tab.classList.add("active");
            document.getElementById(tabId).classList.add("active");
        });
    });

    auth.onAuthStateChanged(user => {
    // إزالة رسالة التحميل إذا كانت موجودة
    const loadingMessage = document.querySelector(".loading-message");
    if (loadingMessage) {
        document.body.removeChild(loadingMessage);
    }

    console.log("تغيرت حالة المصادقة. المستخدم:", user);
    if (user) {
        // تخزين معلومات المستخدم محليًا للمساعدة في استمرارية الجلسة
        localStorage.setItem("userEmail", user.email);
        localStorage.setItem("userUid", user.uid);
        sessionStorage.setItem("currentUserUid", user.uid);
        
        // محاولة تحميل بيانات المستخدم من Firestore
        console.log("محاولة تحميل بيانات المستخدم من Firestore");
        db.collection("users").doc(user.uid).get()
            .then(doc => {
                console.log("تم جلب وثيقة المستخدم:", doc.exists ? "موجودة" : "غير موجودة");
                if (doc.exists) {
                    const userData = doc.data();
                    console.log("بيانات المستخدم:", userData);
                    loadUserData({
                        name: userData.name,
                        email: user.email,
                        balance: userData.balance,
                        cardNumber: userData.cardNumber,
                        payban: userData.payban, // أضف هذا السطر
                        uid: user.uid
                    });
                } else {
                    console.log("لم يتم العثور على وثيقة المستخدم - إنشاء بيانات جديدة");
                    // إنشاء وثيقة المستخدم إذا لم تكن موجودة
                    const cardNumber = generateCardNumber();
                    return db.collection("users").doc(user.uid).set({
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        balance: 0,
                        cardNumber: cardNumber,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        console.log("تم إنشاء وثيقة المستخدم الجديدة");
                        createDefaultWallets(user.uid);
                        loadUserData({
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            balance: 0,
                            cardNumber: cardNumber,
                            payban: userData.payban, // أضف هذا السطر
                            uid: user.uid
                        });
                    });
                }
            })
            .catch(error => {
                console.error("خطأ في جلب بيانات المستخدم:", error);
                
                // محاولة استرجاع البيانات من التخزين المحلي في حالة الفشل
                try {
                    const cachedUserData = JSON.parse(localStorage.getItem("userData"));
                    if (cachedUserData && cachedUserData.uid === user.uid) {
                        console.log("استخدام البيانات المخزنة محليًا:", cachedUserData);
                        loadUserData(cachedUserData);
                        alert(document.documentElement.lang === "ar" ? 
                              "تم تحميل البيانات المخزنة محليًا. بعض البيانات قد لا تكون محدثة." : 
                              "Loaded cached data. Some information may not be up to date.");
                    } else {
                        alert("حدث خطأ أثناء تحميل بيانات المستخدم");
                    }
                } catch (e) {
                    console.error("خطأ في استرجاع البيانات المخزنة محليًا:", e);
                    alert("حدث خطأ أثناء تحميل بيانات المستخدم");
                }
            });
    } else {
        // حذف المعلومات المخزنة محليًا عند تسجيل الخروج
        localStorage.removeItem("userEmail");
        localStorage.removeItem("userUid");
        sessionStorage.removeItem("currentUserUid");
        
        // المستخدم غير مسجل الدخول
        console.log("المستخدم غير مسجل الدخول، عرض نموذج تسجيل الدخول");
        if (dashboard) dashboard.style.display = "none";
        if (loginForm) loginForm.style.display = "block";
        if (registerForm) registerForm.style.display = "none";
    }
});
    // Functions
    function toggleForms(e) {
        e.preventDefault();
        loginForm.style.display = loginForm.style.display === "none" ? "block" : "none";
        registerForm.style.display = registerForm.style.display === "none" ? "block" : "none";
    }

    function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById("registerName").value;
    const email = document.getElementById("registerEmail").value;
    const password = document.getElementById("registerPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    
    if (password !== confirmPassword) {
        alert(document.documentElement.lang === "ar" ? "كلمة المرور غير متطابقة" : "Passwords do not match");
        return;
    }
    
    // إظهار رسالة تحميل
    let loadingMessage = document.createElement('div');
    loadingMessage.textContent = document.documentElement.lang === "ar" ? "جاري إنشاء الحساب..." : "Creating account...";
    loadingMessage.style.textAlign = "center";
    loadingMessage.style.padding = "10px";
    registerForm.appendChild(loadingMessage);
    
    // Create user with Firebase Auth
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("User registered successfully:", userCredential.user);

            // Create user document in Firestore
            const user = userCredential.user;
            const cardNumber = generateCardNumber();
            
            const payban = generatePayBan();

return db.collection("users").doc(user.uid).set({
    name: name,
    email: email,
    balance: 0,
    cardNumber: cardNumber,
    payban: payban,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
})
            .then(() => {
                // Create default wallets for the user
                return createDefaultWallets(user.uid);
            })
            .then(() => {
                registerForm.removeChild(loadingMessage);
                alert(document.documentElement.lang === "ar" ? "تم إنشاء الحساب بنجاح" : "Account created successfully");
                // إعادة تعيين النموذج
                document.getElementById("registerName").value = "";
                document.getElementById("registerEmail").value = "";
                document.getElementById("registerPassword").value = "";
                document.getElementById("confirmPassword").value = "";
                // عرض نموذج تسجيل الدخول
                loginForm.style.display = "block";
                registerForm.style.display = "none";
            });
        })
        .catch((error) => {
            registerForm.removeChild(loadingMessage);
            console.error("Error creating user: ", error);
            alert(error.message);
        });
}
function handleLogin(e) {
    e.preventDefault();
    console.log("محاولة تسجيل الدخول...");
    
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    
    console.log("محاولة تسجيل الدخول بالبريد الإلكتروني:", email);
    
    // إضافة رسالة تحميل
    let loadingMessage = document.createElement('div');
    loadingMessage.textContent = document.documentElement.lang === "ar" ? "جاري تسجيل الدخول..." : "Logging in...";
    loadingMessage.style.textAlign = "center";
    loadingMessage.style.padding = "10px";
    loginForm.appendChild(loadingMessage);
    
    // تسجيل الدخول باستخدام Firebase Auth
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // تسجيل دخول ناجح
            console.log("تم تسجيل الدخول بنجاح:", userCredential.user);
            document.getElementById("loginEmail").value = "";
            document.getElementById("loginPassword").value = "";
            // إزالة رسالة التحميل
            loginForm.removeChild(loadingMessage);
            
            // لن نحتاج إلى تغيير العرض هنا لأن onAuthStateChanged سيقوم بذلك
        })
        .catch((error) => {
            // إزالة رسالة التحميل
            loginForm.removeChild(loadingMessage);
            console.error("خطأ في تسجيل الدخول:", error);
            alert(document.documentElement.lang === "ar" ? "بريد إلكتروني أو كلمة مرور غير صحيحة" : "Invalid email or password");
        });
}

    function handleLogout() {
        auth.signOut()
            .then(() => {
                dashboard.style.display = "none";
                loginForm.style.display = "block";
            })
            .catch((error) => {
                console.error("Error signing out: ", error);
            });
    }

// إضافة هذه الدالة للتعامل مع العمليات المعلقة
function syncPendingOperations() {
    if (!navigator.onLine) {
        console.log("لا يمكن مزامنة العمليات المعلقة: غير متصل بالإنترنت");
        return Promise.resolve();
    }
    
    const pendingOperations = JSON.parse(localStorage.getItem("pendingOperations") || "[]");
    if (pendingOperations.length === 0) {
        console.log("لا توجد عمليات معلقة للمزامنة");
        return Promise.resolve();
    }
    
    console.log("بدء مزامنة العمليات المعلقة:", pendingOperations.length);
    
    const promises = pendingOperations.map((operation, index) => {
        console.log(`معالجة العملية ${index + 1}/${pendingOperations.length}:`, operation);
        
        if (operation.type === "deposit") {
            const userUid = operation.userUid;
            const amount = operation.amount;
            const userRef = db.collection("users").doc(userUid);
            
            return db.runTransaction((transaction) => {
                return transaction.get(userRef).then((userDoc) => {
                    if (!userDoc.exists) {
                        throw "المستخدم غير موجود!";
                    }
                    
                    const userData = userDoc.data();
                    const newBalance = userData.balance + amount;
                    
                    transaction.update(userRef, { balance: newBalance });
                    
                    return { newBalance, index };
                });
            })
            .then(({ newBalance, index }) => {
                return addTransaction(userUid, "deposit", amount, null, "عملية متزامنة")
                    .then(() => {
                        console.log(`تمت مزامنة الإيداع رقم ${index + 1} بنجاح`);
                        return index;
                    });
            });
        } else if (operation.type === "transfer") {
            // يمكن إضافة المنطق الخاص بمزامنة التحويلات هنا
            console.log("مزامنة التحويلات غير مدعومة حاليًا");
            return Promise.resolve(index);
        }
        
        return Promise.resolve(index);
    });
    
    return Promise.all(promises)
        .then((completedIndices) => {
            // إزالة العمليات المكتملة من القائمة
            const newPendingOperations = pendingOperations.filter((_, index) => !completedIndices.includes(index));
            localStorage.setItem("pendingOperations", JSON.stringify(newPendingOperations));
            
            console.log(`تمت مزامنة ${completedIndices.length} عملية بنجاح، تبقى ${newPendingOperations.length} عملية معلقة`);
            
            if (completedIndices.length > 0) {
                // إعادة تحميل بيانات المستخدم لتحديث الواجهة
                const userUid = sessionStorage.getItem("currentUserUid");
                if (userUid) {
                    reloadUserData(userUid);
                }
            }
            
            return completedIndices.length;
        })
        .catch((error) => {
            console.error("خطأ أثناء مزامنة العمليات المعلقة:", error);
            return 0;
        });
}

// استدعاء دالة المزامنة عند استعادة الاتصال
window.addEventListener('online', () => {
    console.log("تمت استعادة الاتصال بالإنترنت");
    syncPendingOperations().then((count) => {
        if (count > 0) {
            alert(document.documentElement.lang === "ar" ? 
                  `تمت مزامنة ${count} عملية معلقة` : 
                  `Successfully synced ${count} pending operations`);
        }
    });
});

// تعديل دالة loadUserData لتخزين البيانات محليًا
function loadUserData(user) {
    console.log("جاري تحميل بيانات المستخدم في واجهة المستخدم:", user);
    
    // تخزين بيانات المستخدم محليًا للاستخدام عند عدم الاتصال
    localStorage.setItem("userData", JSON.stringify(user));
    
    if (userNameDisplay) userNameDisplay.textContent = user.name;
    if (balanceAmount) balanceAmount.textContent = user.balance.toLocaleString();
    if (cardHolderName) cardHolderName.textContent = user.name;
    if (lastFourDigits) lastFourDigits.textContent = user.cardNumber.slice(-4);
    
    // تخزين بيانات المستخدم للوصول السريع
    sessionStorage.setItem("currentUserUid", user.uid);
    localStorage.setItem("userEmail", user.email);
    localStorage.setItem("userUid", user.uid);
    
    loadRecentTransactions(user.uid);
    loadWalletBalances(user.uid);
    
    if (loginForm) loginForm.style.display = "none";
    if (registerForm) registerForm.style.display = "none";
    if (dashboard) {
        dashboard.style.display = "block";
        console.log("تم عرض لوحة التحكم");
    } else {
        console.error("عنصر لوحة التحكم غير موجود!");
    }

    // بعد تحميل البيانات، تحقق من وجود عمليات معلقة للمزامنة
    if (navigator.onLine) {
        syncPendingOperations();
    }
    document.getElementById("paybanDisplay").textContent = user.payban || "غير متوفر";

    console.log("تم تحميل بيانات المستخدم بنجاح وتم عرض لوحة التحكم");
}

function handleDeposit(e) {
  e.preventDefault();

  const type = document.getElementById("depositType").value;
  const userUid = sessionStorage.getItem("currentUserUid");

  if (!userUid) {
    alert(document.documentElement.lang === "ar" ? "يرجى تسجيل الدخول أولاً" : "Please login first");
    return;
  }

  if (type === "bank") {
    const amount = parseFloat(document.getElementById("depositAmount").value);
    if (isNaN(amount) || amount <= 0) {
      alert(document.documentElement.lang === "ar" ? "أدخل مبلغًا صحيحًا" : "Enter a valid amount");
      return;
    }

    const userRef = db.collection("users").doc(userUid);
    db.runTransaction((transaction) => {
      return transaction.get(userRef).then((userDoc) => {
        if (!userDoc.exists) {
          throw "User not found!";
        }

        const userData = userDoc.data();
        const newBalance = userData.balance + amount;

        transaction.update(userRef, { balance: newBalance });
        return newBalance;
      });
    }).then((newBalance) => {
      balanceAmount.textContent = newBalance.toLocaleString();
      depositModal.style.display = "none";
      document.getElementById("depositAmount").value = "";

      // تسجيل المعاملة في السجل
      addTransaction(userUid, "deposit", amount, null, document.documentElement.lang === "ar" ? "إيداع بنكي" : "Bank Deposit");

      alert(document.documentElement.lang === "ar" ? "تم الإيداع بنجاح" : "Deposit successful");
      loadRecentTransactions(userUid);
    }).catch((error) => {
      console.error("فشل الإيداع:", error);
      alert(document.documentElement.lang === "ar" ? "فشل الإيداع" : "Deposit failed");
    });

  } else if (type === "crypto") {
    const crypto = document.getElementById("cryptoType").value;
    const amount = parseFloat(document.getElementById("cryptoAmount").value.replace(",", "."));

    if (isNaN(amount) || amount <= 0) {
      alert(document.documentElement.lang === "ar" ? "أدخل مبلغًا صحيحًا للعملة الرقمية" : "Enter a valid crypto amount");
      return;
    }

    const walletRef = db.collection("wallets").doc(`${userUid}_${crypto}`);
    walletRef.update({
      balance: firebase.firestore.FieldValue.increment(amount)
    }).then(() => {
      depositModal.style.display = "none";
      document.getElementById("cryptoAmount").value = "";

      // تسجيل المعاملة في السجل
      addTransaction(userUid, "crypto_deposit", amount, crypto, document.documentElement.lang === "ar" ?
        `إيداع عملة ${crypto}` :
        `Crypto deposit: ${crypto}`);

      loadWalletBalances(userUid);

      alert(document.documentElement.lang === "ar" ?
        `تم إيداع ${amount} ${crypto}` :
        `Successfully deposited ${amount} ${crypto}`);
    }).catch(error => {
      console.error("فشل إيداع العملة:", error);
      alert(document.documentElement.lang === "ar" ? "فشل إيداع العملة الرقمية" : "Crypto deposit failed");
    });
  }
}

// دالة لمعالجة الإيداع عند الاتصال بالخادم
function processDeposit(userUid, amount, loadingIndicator) {
    const userRef = db.collection("users").doc(userUid);
    
    db.runTransaction((transaction) => {
        return transaction.get(userRef).then((userDoc) => {
            if (!userDoc.exists) {
                throw "المستخدم غير موجود!";
            }
            
            const userData = userDoc.data();
            const newBalance = userData.balance + amount;
            
            transaction.update(userRef, { balance: newBalance });
            
            return newBalance;
        });
    })
    .then((newBalance) => {
        return addTransaction(userUid, "deposit", amount, null, null)
            .then(() => {
                balanceAmount.textContent = newBalance.toLocaleString();
                
                depositModal.removeChild(loadingIndicator);
                depositModal.style.display = "none";
                document.getElementById("depositAmount").value = "";
                
                alert(document.documentElement.lang === "ar" ? "تم الإيداع بنجاح" : "Deposit successful");
                
                loadRecentTransactions(userUid);
            });
    })
    .catch((error) => {
        console.error("فشلت المعاملة: ", error);
        depositModal.removeChild(loadingIndicator);
        
        // رسالة خطأ أكثر تفصيلاً
        alert(document.documentElement.lang === "ar" ? 
              `فشل الإيداع: ${error.code || error}` : 
              `Deposit failed: ${error.code || error}`);
        
        // تخزين العملية محليًا في حالة الفشل
        storePendingDeposit(userUid, amount);
    });
}

// دالة لتخزين الإيداع المعلق
function storePendingDeposit(userUid, amount) {
    try {
        const pendingOperations = JSON.parse(localStorage.getItem("pendingOperations") || "[]");
        pendingOperations.push({
            type: "deposit",
            amount: amount,
            userUid: userUid,
            timestamp: Date.now()
        });
        localStorage.setItem("pendingOperations", JSON.stringify(pendingOperations));
        
        // تحديث واجهة المستخدم مؤقتًا
        const currentBalance = parseFloat(balanceAmount.textContent.replace(/,/g, "")) || 0;
        balanceAmount.textContent = (currentBalance + amount).toLocaleString();
        
        console.log("تم تخزين الإيداع المعلق بنجاح");
    } catch (e) {
        console.error("خطأ في تخزين العملية محليًا:", e);
    }
}

function handleTransfer(e) {
  e.preventDefault();

  const method = document.getElementById("transferMethod").value;
  const recipientInput = document.getElementById("recipientInput").value.trim();
  const amount = parseFloat(document.getElementById("transferAmount").value);
  const note = document.getElementById("transferNote").value;
  const senderUid = sessionStorage.getItem("currentUserUid");
  const transferType = document.getElementById("transferType").value;

if (transferType === "crypto") {
  const currency = document.getElementById("cryptoCurrency").value;
  const toAddress = document.getElementById("cryptoRecipient").value.trim();
  const amount = parseFloat(document.getElementById("cryptoTransferAmount").value.replace(",", "."));

  if (!toAddress || isNaN(amount) || amount <= 0) {
    alert("تحقق من صحة البيانات");
    return;
  }

  const walletRef = db.collection("wallets").doc(`${senderUid}_${currency}`);
  walletRef.get().then(doc => {
    if (!doc.exists || doc.data().balance < amount) {
      throw "رصيد غير كافٍ";
    }

    // إذا العنوان موجود في المنصة → ننقله داخلياً
    return db.collection("wallets")
      .where("address", "==", toAddress)
      .where("type", "==", currency)
      .get();
  }).then(snapshot => {
    const userWalletRef = db.collection("wallets").doc(`${senderUid}_${currency}`);
    const batch = db.batch();

    // خصم من المرسل
    batch.update(userWalletRef, {
      balance: firebase.firestore.FieldValue.increment(-amount)
    });

    if (!snapshot.empty) {
      // تم التحويل لمستخدم داخل المنصة
      const recipientDoc = snapshot.docs[0];
      batch.update(recipientDoc.ref, {
        balance: firebase.firestore.FieldValue.increment(amount)
      });
    }

    return batch.commit().then(() => {
      addTransaction(senderUid, "crypto_sent", amount, `${currency}:${toAddress}`, note);
      alert("تم التحويل بنجاح");
      transferModal.style.display = "none";
      loadWalletBalances(senderUid);
      loadRecentTransactions(senderUid);
    });
  }).catch(error => {
    console.error("فشل تحويل العملة:", error);
    alert("فشل التحويل");
  });

  return;
}

  if (isNaN(amount) || amount <= 0) {
    alert("يرجى إدخال مبلغ صحيح");
    return;
  }

  db.collection("users").doc(senderUid).get().then(senderDoc => {
    if (!senderDoc.exists) throw "المرسل غير موجود";

    const senderData = senderDoc.data();
    if (senderData.balance < amount) {
      alert("رصيد غير كافٍ");
      throw "Insufficient balance";
    }

    // نبدأ البحث عن المستلم حسب الطريقة المختارة
    let query;
    if (method === "email") {
      query = db.collection("users").where("email", "==", recipientInput);
    } else if (method === "username") {
      query = db.collection("users").where("name", "==", recipientInput);
    } else if (method === "payban") {
      query = db.collection("users").where("payban", "==", recipientInput);
    } else {
      throw "طريقة التحويل غير معروفة";
    }

    return query.get().then(snapshot => {
      if (snapshot.empty) {
        alert("المستلم غير موجود");
        throw "Recipient not found";
      }

      const recipientDoc = snapshot.docs[0];
      const recipientUid = recipientDoc.id;

      const batch = db.batch();
      batch.update(db.collection("users").doc(senderUid), {
        balance: firebase.firestore.FieldValue.increment(-amount)
      });
      batch.update(db.collection("users").doc(recipientUid), {
        balance: firebase.firestore.FieldValue.increment(amount)
      });

      return batch.commit().then(() => ({
        senderUid,
        recipientUid,
        recipientInfo: recipientInput
      }));
    });
  }).then(({ senderUid, recipientUid, recipientInfo }) => {
    // سجل المعاملة
    const methodLabel = method === "email" ? "email"
                      : method === "username" ? "username"
                      : "payban";

    addTransaction(senderUid, "sent", amount, `${methodLabel}:${recipientInfo}`, note);
    addTransaction(recipientUid, "received", amount, "from:" + auth.currentUser.email, note);

    // تحديث الواجهة
    return db.collection("users").doc(senderUid).get();
  }).then(updatedSender => {
    balanceAmount.textContent = updatedSender.data().balance.toLocaleString();

    transferModal.style.display = "none";
    document.getElementById("recipientInput").value = "";
    document.getElementById("transferAmount").value = "";
    document.getElementById("transferNote").value = "";

    alert("تم التحويل بنجاح");
    loadRecentTransactions(senderUid);
  }).catch(error => {
    console.error("فشل التحويل:", error);
  });
}


// إضافة هذه الدالة للتعامل مع إعادة الاتصال بـ Firebase
function setupReconnectionHandler() {
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectInterval = 5000; // 5 ثوانٍ
    
    let reconnectTimer = null;
    
    const attemptReconnect = () => {
        if (!navigator.onLine) {
            console.log("لا يمكن إعادة الاتصال: الجهاز غير متصل بالإنترنت");
            return;
        }
        
        if (reconnectAttempts >= maxReconnectAttempts) {
            console.log("تم تجاوز الحد الأقصى لمحاولات إعادة الاتصال");
            clearInterval(reconnectTimer);
            alert(document.documentElement.lang === "ar" ? 
                  "تعذر الاتصال بالخادم. يرجى تحديث الصفحة والمحاولة مرة أخرى." : 
                  "Unable to connect to server. Please refresh the page and try again.");
            return;
        }
        
        reconnectAttempts++;
        console.log(`محاولة إعادة الاتصال ${reconnectAttempts}/${maxReconnectAttempts}...`);
        
        firebase.firestore().enableNetwork()
            .then(() => {
                console.log("تم إعادة الاتصال بـ Firestore بنجاح");
                clearInterval(reconnectTimer);
                reconnectAttempts = 0;
                
                // إعادة تحميل بيانات المستخدم
                const userUid = sessionStorage.getItem("currentUserUid");
                if (userUid) {
                    reloadUserData(userUid);
                }
                
                // مزامنة العمليات المعلقة
                syncPendingOperations();
            })
            .catch((error) => {
                console.error("فشلت محاولة إعادة الاتصال:", error);
            });
    };
    
    // مراقبة حالة الاتصال
    firebase.firestore().onSnapshotsInSync(() => {
        console.log("Firestore متزامن");
    });
    
    window.addEventListener('online', () => {
        console.log("تمت استعادة الاتصال بالإنترنت");
        attemptReconnect();
    });
    
    window.addEventListener('offline', () => {
        console.log("تم فقدان الاتصال بالإنترنت");
        if (reconnectTimer) {
            clearInterval(reconnectTimer);
        }
    });
    
    // مراقبة أخطاء الاتصال بـ Firebase
    db.collection("users").onSnapshot({
        error: (error) => {
            console.error("خطأ في مراقبة المستخدمين:", error);
            
            if (error.code === 'unavailable' || error.code === 'resource-exhausted') {
                console.log("بدء محاولات إعادة الاتصال...");
                if (!reconnectTimer) {
                    reconnectTimer = setInterval(attemptReconnect, reconnectInterval);
                }
            }
        }
    });
}

// استدعاء الدالة بعد تهيئة Firebase
setupReconnectionHandler();

    function addTransaction(userUid, type, amount, otherParty, note) {
        return db.collection("transactions").add({
            userUid,
            type,
            amount,
            otherParty,
            note,
            date: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    function loadRecentTransactions(userUid) {
        db.collection("transactions")
            .where("userUid", "==", userUid)
            .orderBy("date", "desc")
            .limit(5)
            .get()
            .then(querySnapshot => {
                if (querySnapshot.empty) {
                    transactionsList.innerHTML = `
                        <div class="transaction-item">
                            <div>
                                <strong data-ar="لا توجد معاملات" data-en="No transactions yet">لا توجد معاملات</strong>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                transactionsList.innerHTML = "";
                
                querySnapshot.forEach(doc => {
                    const tx = doc.data();
                    const date = tx.date ? tx.date.toDate() : new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                    
                    const transactionItem = document.createElement("div");
                    transactionItem.className = "transaction-item";
                    
                    let typeText, amountHTML;
                    
                    if (tx.type === "deposit") {
                        typeText = document.documentElement.lang === "ar" ? "إيداع" : "Deposit";
                        amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                    } else if (tx.type === "sent") {
                        typeText = document.documentElement.lang === "ar" ? "تحويل إلى" : "Transfer to";
                        typeText += ` ${tx.otherParty}`;
                        amountHTML = `<span style="color: red;">-${tx.amount.toLocaleString()}</span>`;
                    } else if (tx.type === "received") {
                        typeText = document.documentElement.lang === "ar" ? "استلام من" : "Received from";
                        typeText += ` ${tx.otherParty}`;
                        amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                    }
                    else if (tx.type === "crypto_deposit") {
  typeText = document.documentElement.lang === "ar"
    ? `إيداع عملة ${tx.otherParty}`
    : `Crypto deposit (${tx.otherParty})`;
  amountHTML = `<span style="color: green;">+${tx.amount}</span>`;
}

                    transactionItem.innerHTML = `
                        <div>
                            <strong>${typeText}</strong>
                            <div>${formattedDate}</div>
                            ${tx.note ? `<div><small>${tx.note}</small></div>` : ''}
                        </div>
                        <div>
                            ${amountHTML}
                        </div>
                    `;
                    
                    transactionsList.appendChild(transactionItem);
                });
            })
            .catch(error => {
                console.error("Error loading transactions: ", error);
                transactionsList.innerHTML = `
                    <div class="transaction-item">
                        <div>
                            <strong>Error loading transactions</strong>
                        </div>
                    </div>
                `;
            });
    }

    function loadFullTransactionHistory() {
        const userUid = sessionStorage.getItem("currentUserUid");
        
        db.collection("transactions")
            .where("userUid", "==", userUid)
            .orderBy("date", "desc")
            .get()
            .then(querySnapshot => {
                if (querySnapshot.empty) {
                    fullTransactionsList.innerHTML = `
                        <div class="transaction-item">
                            <div>
                                <strong data-ar="لا توجد معاملات" data-en="No transactions yet">لا توجد معاملات</strong>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                fullTransactionsList.innerHTML = "";
                
                querySnapshot.forEach(doc => {
                    const tx = doc.data();
                    const date = tx.date ? tx.date.toDate() : new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    const transactionItem = document.createElement("div");
                    transactionItem.className = "transaction-item";
                    
                    let typeText, amountHTML;
                    
                    if (tx.type === "deposit") {
                        typeText = document.documentElement.lang === "ar" ? "إيداع" : "Deposit";
                        amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                    } else if (tx.type === "sent") {
                        typeText = document.documentElement.lang === "ar" ? "تحويل إلى" : "Transfer to";
                        typeText += ` ${tx.otherParty}`;
                        amountHTML = `<span style="color: red;">-${tx.amount.toLocaleString()}</span>`;
                    } else if (tx.type === "received") {
                        typeText = document.documentElement.lang === "ar" ? "استلام من" : "Received from";
                        typeText += ` ${tx.otherParty}`;
                        amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                    }
                    else if (tx.type === "crypto_deposit") {
  typeText = document.documentElement.lang === "ar"
    ? `إيداع عملة ${tx.otherParty}`
    : `Crypto deposit (${tx.otherParty})`;
  amountHTML = `<span style="color: green;">+${tx.amount}</span>`;
}

                    transactionItem.innerHTML = `
                        <div>
                            <strong>${typeText}</strong>
                            <div>${formattedDate}</div>
                            ${tx.note ? `<div><small>${tx.note}</small></div>` : ''}
                        </div>
                        <div>
                            ${amountHTML}
                        </div>
                    `;
                    
                    fullTransactionsList.appendChild(transactionItem);
                });
            })
            .catch(error => {
                console.error("Error loading transaction history: ", error);
            });
    }

    function createDefaultWallets(userUid) {
    const batch = db.batch();
    
    // Bitcoin wallet ref
    const btcWalletRef = db.collection("wallets").doc(`${userUid}_BTC`);
    batch.set(btcWalletRef, {
        userUid,
        type: "BTC",
        balance: 0,
        address: generateWalletAddress("BTC"),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Ethereum wallet ref
    const ethWalletRef = db.collection("wallets").doc(`${userUid}_ETH`);
    batch.set(ethWalletRef, {
        userUid,
        type: "ETH",
        balance: 0,
        address: generateWalletAddress("ETH"),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Return the batch commit promise
    return batch.commit().then(() => {
        console.log("تم إنشاء المحافظ الافتراضية");
    });
}
    function loadWalletBalances(userUid) {
        db.collection("wallets")
            .where("userUid", "==", userUid)
            .get()
            .then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    const wallet = doc.data();
                    
                    if (wallet.type === "BTC") {
                        btcBalance.textContent = wallet.balance;
                        btcAddress.textContent = wallet.address;
                    } else if (wallet.type === "ETH") {
                        ethBalance.textContent = wallet.balance;
                        ethAddress.textContent = wallet.address;
                    }
                });
            })
            .catch(error => {
                console.error("Error loading wallets: ", error);
            });
    }

    function generateCardNumber() {
        let cardNumber = "4";
        for (let i = 0; i < 15; i++) {
            cardNumber += Math.floor(Math.random() * 10);
        }
        return cardNumber;
    }
    function generatePayBan() {
    const prefix = "mqR#";
    const randomNumber = Math.floor(1000 + Math.random() * 9000); // يعطيك رقم عشوائي 4 خانات
    return prefix + randomNumber;
}

    function generateWalletAddress(type) {
        if (type === "BTC") {
            const prefix = "bc1";
            let address = prefix;
            const chars = "qwertyuiopasdfghjklzxcvbnm1234567890";
            for (let i = 0; i < 35; i++) {
                address += chars[Math.floor(Math.random() * chars.length)];
            }
            return address;
        } else if (type === "ETH") {
            const prefix = "0x";
            let address = prefix;
            const chars = "abcdef1234567890";
            for (let i = 0; i < 40; i++) {
                address += chars[Math.floor(Math.random() * chars.length)];
            }
            return address;
        }
        return "";
    }

    function checkFirebaseConnection() {
    return new Promise((resolve, reject) => {
        // إنشاء مستند اختبار للتحقق من الاتصال
        const testRef = db.collection("_connection_test").doc("test");
        testRef.set({
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            console.log("تم التحقق من الاتصال بـ Firebase بنجاح");
            resolve(true);
        })
        .catch((error) => {
            console.error("فشل الاتصال بـ Firebase:", error);
            reject(error);
        });
    });
}

    // Language toggle
    window.toggleLanguage = function() {
        const currentLang = document.body.classList.contains("rtl") ? "ar" : "en";
        const newLang = currentLang === "ar" ? "en" : "ar";
        
        if (newLang === "en") {
            document.body.classList.remove("rtl");
            document.body.classList.add("ltr");
            document.documentElement.lang = "en";
            document.querySelector(".language-toggle").textContent = "العربية";
        } else {
            document.body.classList.remove("ltr");
            document.body.classList.add("rtl");
            document.documentElement.lang = "ar";
            document.querySelector(".language-toggle").textContent = "English";
        }
        
        // Update all elements with data-ar and data-en attributes
        const elements = document.querySelectorAll("[data-ar][data-en]");
        elements.forEach(el => {
            el.textContent = el.getAttribute(`data-${newLang}`);
        });
    };

    // Window click event to close modals when clicking outside
    window.onclick = function(event) {
        if (event.target === depositModal) {
            depositModal.style.display = "none";
        }
        if (event.target === transferModal) {
            transferModal.style.display = "none";
        }
        if (event.target === historyModal) {
            historyModal.style.display = "none";
        }
    };


    document.getElementById("depositType").addEventListener("change", function () {
  const type = this.value;
  document.getElementById("bankDepositGroup").style.display = type === "bank" ? "block" : "none";
  document.getElementById("cryptoDepositGroup").style.display = type === "crypto" ? "block" : "none";
});





document.getElementById("cryptoAmount").addEventListener("input", async () => {
  const crypto = document.getElementById("cryptoType").value;
  const amount = parseFloat(document.getElementById("cryptoAmount").value.replace(",", "."));
  const preview = document.getElementById("cryptoDollarPreview");

  if (isNaN(amount) || amount <= 0) {
    preview.textContent = "";
    return;
  }

  const rates = {
    BTC: 64000,  // افترض السعر الحالي
    ETH: 3100
  };

  const dollarValue = (amount * rates[crypto]).toFixed(2);
  preview.textContent = document.documentElement.lang === "ar"
    ? `${amount} ${crypto} ≈ ${dollarValue} دولار`
    : `${amount} ${crypto} ≈ $${dollarValue} USD`;
});



document.getElementById("cryptoTransferAmount").addEventListener("input", () => {
  const currency = document.getElementById("cryptoCurrency").value;
  const amount = parseFloat(document.getElementById("cryptoTransferAmount").value.replace(",", "."));
  const rate = { BTC: 64000, ETH: 3100 };
  const usd = (rate[currency] * amount).toFixed(2);
  const label = document.documentElement.lang === "ar"
    ? `${amount} ${currency} ≈ ${usd}$`
    : `${amount} ${currency} ≈ $${usd}`;
  document.getElementById("cryptoUSDPreview").textContent = isNaN(amount) ? "" : label;
});


});   </script>
</body>
</html>