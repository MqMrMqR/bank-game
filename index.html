<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANK GAME</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.21.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.21.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.21.0/firebase-auth-compat.min.js"></script>
    <style>
        :root {
            --primary-color: #000;
            --secondary-color: #fff;
            --accent-color: #333;
            --text-color: #000;
            --background-color: #fff;
            --border-color: #ddd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        .rtl {
            direction: rtl;
            text-align: right;
        }

        .ltr {
            direction: ltr;
            text-align: left;
        }

        header {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            color: var(--secondary-color);
        }

        .language-toggle {
            background: transparent;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .login-container, .register-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .balance {
            font-size: 2rem;
            font-weight: bold;
        }

        .currency {
            font-size: 0.8rem;
            color: #777;
        }

        .card {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .card-number {
            font-size: 1.2rem;
            letter-spacing: 4px;
            margin: 1rem 0;
        }

        .card-holder {
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .card-expiry {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            font-size: 0.8rem;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .action-item {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .transactions {
            margin-top: 2rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        form {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--accent-color);
        }

        .wallet-container {
            margin-top: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .wallet-address {
            font-family: monospace;
            padding: 0.5rem;
            background-color: #f5f5f5;
            border-radius: 4px;
            margin: 0.5rem 0;
            word-break: break-all;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--background-color);
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .tab-container {
            margin-top: 2rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            padding: 1.5rem 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="rtl">
    <header>
        <a href="#" class="logo">BANK GAME</a>
        <button class="language-toggle" onclick="toggleLanguage()">English</button>
    </header>

    <div class="container">
        <!-- Login Form -->
        <div class="login-container" id="loginForm">
            <h2 data-ar="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" data-en="Login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <form id="login">
                <div class="form-group">
                    <label for="loginEmail" data-ar="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-en="Email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword" data-ar="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-en="Password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" data-ar="Ø¯Ø®ÙˆÙ„" data-en="Login">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                <a href="#" id="showRegister" data-ar="Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†" data-en="Don't have an account? Register now">Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</a>
            </p>
        </div>

        <!-- Register Form -->
        <div class="register-container" id="registerForm" style="display: none;">
            <h2 data-ar="Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" data-en="Create New Account">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <form id="register">
                <div class="form-group">
                    <label for="registerName" data-ar="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" data-en="Full Name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail" data-ar="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-en="Email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword" data-ar="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-en="Password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword" data-ar="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-en="Confirm Password">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <button type="submit" data-ar="ØªØ³Ø¬ÙŠÙ„" data-en="Register">ØªØ³Ø¬ÙŠÙ„</button>
            </form>
            <p style="margin-top: 1rem; text-align: center;">
                <a href="#" id="showLogin" data-ar="Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" data-en="Already have an account? Login">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
            </p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <div>
                    <h2 data-ar="Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ " data-en="Welcome, "><span id="userNameDisplay">Ù…Ø³ØªØ®Ø¯Ù…</span></h2>
                </div>
                <button id="logoutBtn" data-ar="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" data-en="Logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>

            <div class="card">
                <h3 data-ar="Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†" data-en="Credit Card">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†</h3>
                <div class="card-number">**** **** **** <span id="lastFourDigits">1234</span></div>
                <div class="card-holder" id="cardHolderName">Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</div>
                <div class="card-expiry">12/28</div>
            </div>

            <div class="balance-section">
                <h3 data-ar="Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ" data-en="Current Balance">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                <div class="balance"><span id="balanceAmount">0</span> <span class="currency" data-ar="Ø±ÙŠØ§Ù„" data-en="SAR">Ø±ÙŠØ§Ù„</span></div>
            </div>

            <div class="actions">
                <div class="action-item" id="depositBtn">
                    <div class="action-icon">ğŸ’°</div>
                    <h3 data-ar="Ø¥ÙŠØ¯Ø§Ø¹" data-en="Deposit">Ø¥ÙŠØ¯Ø§Ø¹</h3>
                </div>
                <div class="action-item" id="transferBtn">
                    <div class="action-icon">â†—ï¸</div>
                    <h3 data-ar="ØªØ­ÙˆÙŠÙ„" data-en="Transfer">ØªØ­ÙˆÙŠÙ„</h3>
                </div>
                <div class="action-item" id="walletsBtn">
                    <div class="action-icon">ğŸ’¼</div>
                    <h3 data-ar="Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©" data-en="Digital Wallets">Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h3>
                </div>
                <div class="action-item" id="historyBtn">
                    <div class="action-icon">ğŸ“œ</div>
                    <h3 data-ar="Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" data-en="Transaction History">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                </div>
            </div>

            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="recent-transactions" data-ar="Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" data-en="Recent Transactions">Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                    <div class="tab" data-tab="wallets" data-ar="Ø§Ù„Ù…Ø­Ø§ÙØ¸" data-en="Wallets">Ø§Ù„Ù…Ø­Ø§ÙØ¸</div>
                </div>

                <div class="tab-content">
                    <div class="tab-pane active" id="recent-transactions">
                        <div class="transactions" id="transactionsList">
                            <div class="transaction-item">
                                <div>
                                    <strong data-ar="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª" data-en="No transactions yet">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="wallets">
                        <div class="wallet-container">
                            <div class="wallet-header">
                                <h3>Bitcoin (BTC)</h3>
                                <div><span id="btcBalance">0</span> BTC</div>
                            </div>
                            <div>
                                <p data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:" data-en="Wallet Address:">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:</p>
                                <div class="wallet-address" id="btcAddress">bc1q87de3fagf7agfg78afg78ga78fg7a8g7</div>
                            </div>
                        </div>
                        
                        <div class="wallet-container">
                            <div class="wallet-header">
                                <h3>Ethereum (ETH)</h3>
                                <div><span id="ethBalance">0</span> ETH</div>
                            </div>
                            <div>
                                <p data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:" data-en="Wallet Address:">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:</p>
                                <div class="wallet-address" id="ethAddress">0x87de3f7agf7agfg78afg78ga78fg7a8g7</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <span class="close-modal" id="closeDepositModal">&times;</span>
            <h2 data-ar="Ø¥ÙŠØ¯Ø§Ø¹ Ø£Ù…ÙˆØ§Ù„" data-en="Deposit Money">Ø¥ÙŠØ¯Ø§Ø¹ Ø£Ù…ÙˆØ§Ù„</h2>
            <form id="depositForm">
                <div class="form-group">
                    <label for="depositAmount" data-ar="Ø§Ù„Ù…Ø¨Ù„Øº" data-en="Amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input type="number" id="depositAmount" min="1" required>
                </div>
                <button type="submit" data-ar="Ø¥ÙŠØ¯Ø§Ø¹" data-en="Deposit">Ø¥ÙŠØ¯Ø§Ø¹</button>
            </form>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <span class="close-modal" id="closeTransferModal">&times;</span>
            <h2 data-ar="ØªØ­ÙˆÙŠÙ„ Ø£Ù…ÙˆØ§Ù„" data-en="Transfer Money">ØªØ­ÙˆÙŠÙ„ Ø£Ù…ÙˆØ§Ù„</h2>
            <form id="transferForm">
                <div class="form-group">
                    <label for="recipientEmail" data-ar="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…" data-en="Recipient Email">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                    <input type="email" id="recipientEmail" required>
                </div>
                <div class="form-group">
                    <label for="transferAmount" data-ar="Ø§Ù„Ù…Ø¨Ù„Øº" data-en="Amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                    <input type="number" id="transferAmount" min="1" required>
                </div>
                <div class="form-group">
                    <label for="transferNote" data-ar="Ù…Ù„Ø§Ø­Ø¸Ø©" data-en="Note">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                    <input type="text" id="transferNote">
                </div>
                <button type="submit" data-ar="ØªØ­ÙˆÙŠÙ„" data-en="Transfer">ØªØ­ÙˆÙŠÙ„</button>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <span class="close-modal" id="closeHistoryModal">&times;</span>
            <h2 data-ar="Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" data-en="Transaction History">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <div id="fullTransactionsList">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAT0VfDrqizMR3y0QGmZc3WAzRGZ1xTcGo",
          authDomain: "mqrbank-e0c06.firebaseapp.com",
          projectId: "mqrbank-e0c06",
          storageBucket: "mqrbank-e0c06.firebasestorage.app",
          messagingSenderId: "677309991252",
          appId: "1:677309991252:web:abc8e543219fb24856e0c1"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
      </script>

    <script>

  // Initialize Firebase
 // const app = initializeApp(firebaseConfig);
// Initialize Firestore and Authentication
//const db = firebase.firestore();
//const auth = firebase.auth();

// DOM Elements
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const dashboard = document.getElementById("dashboard");
const showRegisterLink = document.getElementById("showRegister");
const showLoginLink = document.getElementById("showLogin");
const logoutBtn = document.getElementById("logoutBtn");
const userNameDisplay = document.getElementById("userNameDisplay");
const balanceAmount = document.getElementById("balanceAmount");
const cardHolderName = document.getElementById("cardHolderName");
const lastFourDigits = document.getElementById("lastFourDigits");
const depositBtn = document.getElementById("depositBtn");
const transferBtn = document.getElementById("transferBtn");
const walletsBtn = document.getElementById("walletsBtn");
const historyBtn = document.getElementById("historyBtn");
const depositModal = document.getElementById("depositModal");
const transferModal = document.getElementById("transferModal");
const historyModal = document.getElementById("historyModal");
const closeDepositModal = document.getElementById("closeDepositModal");
const closeTransferModal = document.getElementById("closeTransferModal");
const closeHistoryModal = document.getElementById("closeHistoryModal");
const depositForm = document.getElementById("depositForm");
const transferForm = document.getElementById("transferForm");
const transactionsList = document.getElementById("transactionsList");
const fullTransactionsList = document.getElementById("fullTransactionsList");
const tabs = document.querySelectorAll(".tab");
const tabPanes = document.querySelectorAll(".tab-pane");
const btcBalance = document.getElementById("btcBalance");
const ethBalance = document.getElementById("ethBalance");
const btcAddress = document.getElementById("btcAddress");
const ethAddress = document.getElementById("ethAddress");

// Event Listeners
document.getElementById("login").addEventListener("submit", handleLogin);
document.getElementById("register").addEventListener("submit", handleRegister);
showRegisterLink.addEventListener("click", toggleForms);
showLoginLink.addEventListener("click", toggleForms);
logoutBtn.addEventListener("click", handleLogout);
depositBtn.addEventListener("click", () => depositModal.style.display = "flex");
transferBtn.addEventListener("click", () => transferModal.style.display = "flex");
historyBtn.addEventListener("click", () => {
    loadFullTransactionHistory();
    historyModal.style.display = "flex";
});
closeDepositModal.addEventListener("click", () => depositModal.style.display = "none");
closeTransferModal.addEventListener("click", () => transferModal.style.display = "none");
closeHistoryModal.addEventListener("click", () => historyModal.style.display = "none");
depositForm.addEventListener("submit", handleDeposit);
transferForm.addEventListener("submit", handleTransfer);

tabs.forEach(tab => {
    tab.addEventListener("click", () => {
        const tabId = tab.getAttribute("data-tab");
        
        // Remove active class from all tabs and panes
        tabs.forEach(t => t.classList.remove("active"));
        tabPanes.forEach(p => p.classList.remove("active"));
        
        // Add active class to current tab and pane
        tab.classList.add("active");
        document.getElementById(tabId).classList.add("active");
    });
});

// Check authentication state on load
auth.onAuthStateChanged(user => {
    if (user) {
        // User is signed in
        db.collection("users").doc(user.uid).get()
            .then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    loadUserData({
                        name: userData.name,
                        email: user.email,
                        balance: userData.balance,
                        cardNumber: userData.cardNumber,
                        uid: user.uid
                    });
                }
            });
    } else {
        // User is signed out
        dashboard.style.display = "none";
        loginForm.style.display = "block";
    }
});

// Functions
function toggleForms(e) {
    e.preventDefault();
    loginForm.style.display = loginForm.style.display === "none" ? "block" : "none";
    registerForm.style.display = registerForm.style.display === "none" ? "block" : "none";
}

function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById("registerName").value;
    const email = document.getElementById("registerEmail").value;
    const password = document.getElementById("registerPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    
    if (password !== confirmPassword) {
        alert(document.documentElement.lang === "ar" ? "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©" : "Passwords do not match");
        return;
    }
    
    // Create user with Firebase Auth
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // Create user document in Firestore
            const user = userCredential.user;
            const cardNumber = generateCardNumber();
            
            db.collection("users").doc(user.uid).set({
                name: name,
                email: email,
                balance: 0,
                cardNumber: cardNumber,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Create default wallets for the user
                createDefaultWallets(user.uid);
                
                alert(document.documentElement.lang === "ar" ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­" : "Account created successfully");
                loginForm.style.display = "block";
                registerForm.style.display = "none";
            })
            .catch((error) => {
                console.error("Error creating user document: ", error);
                alert(error.message);
            });
        })
        .catch((error) => {
            console.error("Error creating user: ", error);
            alert(error.message);
        });
}

function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    
    // Sign in with Firebase Auth
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // Successful login
            document.getElementById("loginEmail").value = "";
            document.getElementById("loginPassword").value = "";
        })
        .catch((error) => {
            console.error("Error signing in: ", error);
            alert(document.documentElement.lang === "ar" ? "Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©" : "Invalid email or password");
        });
}

function handleLogout() {
    auth.signOut()
        .then(() => {
            dashboard.style.display = "none";
            loginForm.style.display = "block";
        })
        .catch((error) => {
            console.error("Error signing out: ", error);
        });
}

function loadUserData(user) {
    userNameDisplay.textContent = user.name;
    balanceAmount.textContent = user.balance.toLocaleString();
    cardHolderName.textContent = user.name;
    lastFourDigits.textContent = user.cardNumber.slice(-4);
    
    // Store user data for quick access
    sessionStorage.setItem("currentUserUid", user.uid);
    
    loadRecentTransactions(user.uid);
    loadWalletBalances(user.uid);
    
    loginForm.style.display = "none";
    registerForm.style.display = "none";
    dashboard.style.display = "block";
}

function handleDeposit(e) {
    e.preventDefault();
    
    const amount = parseFloat(document.getElementById("depositAmount").value);
    if (isNaN(amount) || amount <= 0) {
        alert(document.documentElement.lang === "ar" ? "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­" : "Please enter a valid amount");
        return;
    }
    
    const userUid = sessionStorage.getItem("currentUserUid");
    const userRef = db.collection("users").doc(userUid);
    
    // Use a transaction to update the balance
    db.runTransaction((transaction) => {
        return transaction.get(userRef).then((userDoc) => {
            if (!userDoc.exists) {
                throw "User does not exist!";
            }
            
            const userData = userDoc.data();
            const newBalance = userData.balance + amount;
            
            transaction.update(userRef, { balance: newBalance });
            
            // Return the new balance for use in the next then()
            return newBalance;
        });
    })
    .then((newBalance) => {
        // Add transaction record
        addTransaction(userUid, "deposit", amount, null, null);
        
        // Update UI
        balanceAmount.textContent = newBalance.toLocaleString();
        
        // Close modal and reset form
        depositModal.style.display = "none";
        document.getElementById("depositAmount").value = "";
        
        alert(document.documentElement.lang === "ar" ? "ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­" : "Deposit successful");
        
        // Reload transactions
        loadRecentTransactions(userUid);
    })
    .catch((error) => {
        console.error("Transaction failed: ", error);
        alert(error);
    });
}

function handleTransfer(e) {
    e.preventDefault();
    
    const recipientEmail = document.getElementById("recipientEmail").value;
    const amount = parseFloat(document.getElementById("transferAmount").value);
    const note = document.getElementById("transferNote").value;
    
    if (isNaN(amount) || amount <= 0) {
        alert(document.documentElement.lang === "ar" ? "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­" : "Please enter a valid amount");
        return;
    }
    
    const senderUid = sessionStorage.getItem("currentUserUid");
    
    // Get sender's current balance
    db.collection("users").doc(senderUid).get()
        .then(doc => {
            if (!doc.exists) {
                throw "Sender does not exist!";
            }
            
            const senderData = doc.data();
            
            if (senderData.balance < amount) {
                alert(document.documentElement.lang === "ar" ? "Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ" : "Insufficient balance");
                return;
            }
            
            // Find recipient by email
            return db.collection("users").where("email", "==", recipientEmail).get();
        })
        .then(querySnapshot => {
            if (querySnapshot.empty) {
                alert(document.documentElement.lang === "ar" ? "Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" : "Recipient not found");
                throw "Recipient not found";
            }
            
            // Get recipient document
            const recipientDoc = querySnapshot.docs[0];
            const recipientUid = recipientDoc.id;
            
            // Use batch write to ensure both operations occur
            const batch = db.batch();
            
            // Update sender balance
            const senderRef = db.collection("users").doc(senderUid);
            batch.update(senderRef, {
                balance: firebase.firestore.FieldValue.increment(-amount)
            });
            
            // Update recipient balance
            const recipientRef = db.collection("users").doc(recipientUid);
            batch.update(recipientRef, {
                balance: firebase.firestore.FieldValue.increment(amount)
            });
            
            // Commit the batch
            return batch.commit().then(() => {
                return {
                    senderUid,
                    recipientUid,
                    recipientEmail
                };
            });
        })
        .then(({senderUid, recipientUid, recipientEmail}) => {
            // Add transaction records
            addTransaction(senderUid, "sent", amount, recipientEmail, note);
            addTransaction(recipientUid, "received", amount, auth.currentUser.email, note);
            
            // Get updated sender data
            return db.collection("users").doc(senderUid).get();
        })
        .then(doc => {
            const userData = doc.data();
            
            // Update UI
            balanceAmount.textContent = userData.balance.toLocaleString();
            
            // Close modal and reset form
            transferModal.style.display = "none";
            document.getElementById("recipientEmail").value = "";
            document.getElementById("transferAmount").value = "";
            document.getElementById("transferNote").value = "";
            
            alert(document.documentElement.lang === "ar" ? "ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­" : "Transfer successful");
            
            // Reload transactions
            loadRecentTransactions(senderUid);
        })
        .catch((error) => {
            if (error !== "Recipient not found") {
                console.error("Transfer failed: ", error);
                alert(error);
            }
        });
}

function addTransaction(userUid, type, amount, otherParty, note) {
    return db.collection("transactions").add({
        userUid,
        type,
        amount,
        otherParty,
        note,
        date: firebase.firestore.FieldValue.serverTimestamp()
    });
}

function loadRecentTransactions(userUid) {
    db.collection("transactions")
        .where("userUid", "==", userUid)
        .orderBy("date", "desc")
        .limit(5)
        .get()
        .then(querySnapshot => {
            if (querySnapshot.empty) {
                transactionsList.innerHTML = `
                    <div class="transaction-item">
                        <div>
                            <strong data-ar="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª" data-en="No transactions yet">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</strong>
                        </div>
                    </div>
                `;
                return;
            }
            
            transactionsList.innerHTML = "";
            
            querySnapshot.forEach(doc => {
                const tx = doc.data();
                const date = tx.date ? tx.date.toDate() : new Date();
                const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                
                const transactionItem = document.createElement("div");
                transactionItem.className = "transaction-item";
                
                let typeText, amountHTML;
                
                if (tx.type === "deposit") {
                    typeText = document.documentElement.lang === "ar" ? "Ø¥ÙŠØ¯Ø§Ø¹" : "Deposit";
                    amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                } else if (tx.type === "sent") {
                    typeText = document.documentElement.lang === "ar" ? "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰" : "Transfer to";
                    typeText += ` ${tx.otherParty}`;
                    amountHTML = `<span style="color: red;">-${tx.amount.toLocaleString()}</span>`;
                } else if (tx.type === "received") {
                    typeText = document.documentElement.lang === "ar" ? "Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†" : "Received from";
                    typeText += ` ${tx.otherParty}`;
                    amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                }
                
                transactionItem.innerHTML = `
                    <div>
                        <strong>${typeText}</strong>
                        <div>${formattedDate}</div>
                        ${tx.note ? `<div><small>${tx.note}</small></div>` : ''}
                    </div>
                    <div>
                        ${amountHTML}
                    </div>
                `;
                
                transactionsList.appendChild(transactionItem);
            });
        })
        .catch(error => {
            console.error("Error loading transactions: ", error);
            transactionsList.innerHTML = `
                <div class="transaction-item">
                    <div>
                        <strong>Error loading transactions</strong>
                    </div>
                </div>
            `;
        });
}

function loadFullTransactionHistory() {
    const userUid = sessionStorage.getItem("currentUserUid");
    
    db.collection("transactions")
        .where("userUid", "==", userUid)
        .orderBy("date", "desc")
        .get()
        .then(querySnapshot => {
            if (querySnapshot.empty) {
                fullTransactionsList.innerHTML = `
                    <div class="transaction-item">
                        <div>
                            <strong data-ar="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª" data-en="No transactions yet">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</strong>
                        </div>
                    </div>
                `;
                return;
            }
            
            fullTransactionsList.innerHTML = "";
            
            querySnapshot.forEach(doc => {
                const tx = doc.data();
                const date = tx.date ? tx.date.toDate() : new Date();
                const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                const transactionItem = document.createElement("div");
                transactionItem.className = "transaction-item";
                
                let typeText, amountHTML;
                
                if (tx.type === "deposit") {
                    typeText = document.documentElement.lang === "ar" ? "Ø¥ÙŠØ¯Ø§Ø¹" : "Deposit";
                    amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                } else if (tx.type === "sent") {
                    typeText = document.documentElement.lang === "ar" ? "ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰" : "Transfer to";
                    typeText += ` ${tx.otherParty}`;
                    amountHTML = `<span style="color: red;">-${tx.amount.toLocaleString()}</span>`;
                } else if (tx.type === "received") {
                    typeText = document.documentElement.lang === "ar" ? "Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†" : "Received from";
                    typeText += ` ${tx.otherParty}`;
                    amountHTML = `<span style="color: green;">+${tx.amount.toLocaleString()}</span>`;
                }
                
                transactionItem.innerHTML = `
                    <div>
                        <strong>${typeText}</strong>
                        <div>${formattedDate}</div>
                        ${tx.note ? `<div><small>${tx.note}</small></div>` : ''}
                    </div>
                    <div>
                        ${amountHTML}
                    </div>
                `;
                
                fullTransactionsList.appendChild(transactionItem);
            });
        })
        .catch(error => {
            console.error("Error loading transaction history: ", error);
        });
}

function createDefaultWallets(userUid) {
    // Create Bitcoin wallet
    db.collection("wallets").add({
        userUid,
        type: "BTC",
        balance: 0,
        address: generateWalletAddress("BTC"),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Create Ethereum wallet
    db.collection("wallets").add({
        userUid,
        type: "ETH",
        balance: 0,
        address: generateWalletAddress("ETH"),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}

function loadWalletBalances(userUid) {
    db.collection("wallets")
        .where("userUid", "==", userUid)
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                const wallet = doc.data();
                
                if (wallet.type === "BTC") {
                    btcBalance.textContent = wallet.balance;
                    btcAddress.textContent = wallet.address;
                } else if (wallet.type === "ETH") {
                    ethBalance.textContent = wallet.balance;
                    ethAddress.textContent = wallet.address;
                }
            });
        })
        .catch(error => {
            console.error("Error loading wallets: ", error);
        });
}

function generateCardNumber() {
    let cardNumber = "4";
    for (let i = 0; i < 15; i++) {
        cardNumber += Math.floor(Math.random() * 10);
    }
    return cardNumber;
}

function generateWalletAddress(type) {
    if (type === "BTC") {
        const prefix = "bc1";
        let address = prefix;
        const chars = "qwertyuiopasdfghjklzxcvbnm1234567890";
        for (let i = 0; i < 35; i++) {
            address += chars[Math.floor(Math.random() * chars.length)];
        }
        return address;
    } else if (type === "ETH") {
        const prefix = "0x";
        let address = prefix;
        const chars = "abcdef1234567890";
        for (let i = 0; i < 40; i++) {
            address += chars[Math.floor(Math.random() * chars.length)];
        }
        return address;
    }
    return "";
}

// Language toggle
function toggleLanguage() {
    const currentLang = document.body.classList.contains("rtl") ? "ar" : "en";
    const newLang = currentLang === "ar" ? "en" : "ar";
    
    if (newLang === "en") {
        document.body.classList.remove("rtl");
        document.body.classList.add("ltr");
        document.documentElement.lang = "en";
        document.querySelector(".language-toggle").textContent = "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
    } else {
        document.body.classList.remove("ltr");
        document.body.classList.add("rtl");
        document.documentElement.lang = "ar";
        document.querySelector(".language-toggle").textContent = "English";
    }
    
    // Update all elements with data-ar and data-en attributes
    const elements = document.querySelectorAll("[data-ar][data-en]");
    elements.forEach(el => {
        el.textContent = el.getAttribute(`data-${newLang}`);
    });
}

// Window click event to close modals when clicking outside
window.onclick = function(event) {
    if (event.target === depositModal) {
        depositModal.style.display = "none";
    }
    if (event.target === transferModal) {
        transferModal.style.display = "none";
    }
    if (event.target === historyModal) {
        historyModal.style.display = "none";
    }
};    </script>
</body>
</html>